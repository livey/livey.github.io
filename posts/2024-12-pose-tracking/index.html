<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Pose Tracking with Iterative Extended Kalman Filter | Fuwei's Tech Notes</title>
<meta name=keywords content="Autonomous Driving,Signal Processing,Pose Tracking,Kalman Filter"><meta name=description content="Pose Tracking with Iterative Extended Kalman Filter"><meta name=author content="Fuwei Li"><link rel=canonical href=https://livey.github.io><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://livey.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://livey.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://livey.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://livey.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://livey.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://livey.github.io/posts/2024-12-pose-tracking/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><meta name=author content="Fuwei Li"><meta name=description content="Pose Tracking with Iterative Extended Kalman Filter"><meta property="og:type" content="article"><meta property="og:url" content="https://livey.github.io/posts/2024-12-pose-tracking/"><meta property="og:title" content="Pose Tracking with Iterative Extended Kalman Filter"><meta property="og:description" content="Pose Tracking with Iterative Extended Kalman Filter"><meta property="og:image" content="https://livey.github.io/images/site-preview.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Pose Tracking with Iterative Extended Kalman Filter"><meta name=twitter:description content="Pose Tracking with Iterative Extended Kalman Filter"><meta name=twitter:image content="https://livey.github.io/images/site-preview.jpg"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><meta property="og:url" content="https://livey.github.io/posts/2024-12-pose-tracking/"><meta property="og:site_name" content="Fuwei's Tech Notes"><meta property="og:title" content="Pose Tracking with Iterative Extended Kalman Filter"><meta property="og:description" content="Pose Tracking with Iterative Extended Kalman Filter"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-24T00:00:00+00:00"><meta property="article:tag" content="Autonomous-Driving"><meta property="article:tag" content="Signal Processing"><meta property="article:tag" content="Pose Tracking"><meta property="article:tag" content="Kalman Filter"><meta property="og:image" content="https://livey.github.io/posts/2024-12-pose-tracking/%3Cimage%20path/url%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://livey.github.io/posts/2024-12-pose-tracking/%3Cimage%20path/url%3E"><meta name=twitter:title content="Pose Tracking with Iterative Extended Kalman Filter"><meta name=twitter:description content="Pose Tracking with Iterative Extended Kalman Filter"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://livey.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Pose Tracking with Iterative Extended Kalman Filter","item":"https://livey.github.io/posts/2024-12-pose-tracking/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Pose Tracking with Iterative Extended Kalman Filter","name":"Pose Tracking with Iterative Extended Kalman Filter","description":"Pose Tracking with Iterative Extended Kalman Filter","keywords":["Autonomous Driving","Signal Processing","Pose Tracking","Kalman Filter"],"articleBody":"Tracking ego pose is critical in autonomous driving. In this article, we will discuss how to fuse the IMU, wheel encoder, GPS, etc. to track the ego pose. We will derive the pose tracking algorithm based on the iterative extended Kalman filter. This document mainly follows [1] and [2].\nPreliminaries Let $\\mathcal{M}$ be the manifold of dimension $n$ in consideration (e.g., $\\mathcal{M} = SO(3)$). Since manifolds are locally homeomorphic to $\\mathbb{R}^n$, we can establish a bijective mapping from a local neighborhood on $\\mathcal{M}$ to its tangent space $\\mathbb{R}^n$ via two encapsulation operators $\\boxplus$ and $\\boxminus$:\n$$\\boxplus : \\mathcal{M} \\times \\mathbb{R}^n \\to \\mathcal{M}; \\boxminus : \\mathcal{M} \\times \\mathcal{M} \\to \\mathbb{R}^n$$$$ \\text{for } \\mathcal{M} = SO(3) : \\mathbf{R} \\boxplus \\mathbf{r} = \\mathbf{R} \\text{Exp}(\\mathbf{r});\\quad \\mathbf{R}_1 \\boxminus \\mathbf{R}_2 = \\text{Log}(\\mathbf{R}_2^T \\mathbf{R}_1) $$$$\\text{for }\\mathcal{M} = \\mathbb{R}^n : \\mathbf{a} \\boxplus \\mathbf{b} = \\mathbf{a} + \\mathbf{b}; \\quad \\mathbf{a} \\boxminus \\mathbf{b} = \\mathbf{a} - \\mathbf{b} $$where $\\text{Exp}(\\cdot)$ is the exponential map and $\\text{Log}(\\cdot)$ is its inverse map.\n$$\\text{Exp}(\\theta \\mathbf{u})=\\mathbf{R}(\\boldsymbol{\\theta}) \\triangleq \\mathbf{I} + \\sin\\theta[\\mathbf{u} ]_\\times + (1-\\cos\\theta)[\\mathbf{u}]_\\times^2, $$$$[\\boldsymbol{\\theta}]_\\times= \\begin{bmatrix} 0\u0026-\\theta_z\u0026\\theta_y\\\\ \\theta_z\u00260\u0026-\\theta_x\\\\ -\\theta_y\u0026\\theta_x\u00260 \\end{bmatrix}, $$where $\\boldsymbol{\\theta}= \\theta\\mathbf{u}$ and $\\|\\mathbf{u}\\|=1$.\n$$\\mathcal{M} = SO(3) \\times \\mathbb{R}^n$$ we have:\n$$\\begin{bmatrix} \\mathbf{R} \\\\ \\mathbf{a} \\end{bmatrix} \\boxplus \\begin{bmatrix} \\mathbf{r} \\\\ \\mathbf{b} \\end{bmatrix} = \\begin{bmatrix} \\mathbf{R} \\boxplus \\mathbf{r} \\\\ \\mathbf{a} + \\mathbf{b} \\end{bmatrix}; \\quad \\begin{bmatrix} \\mathbf{R}_1 \\\\ \\mathbf{a} \\end{bmatrix} \\boxminus \\begin{bmatrix} \\mathbf{R}_2 \\\\ \\mathbf{b} \\end{bmatrix} = \\begin{bmatrix} \\mathbf{R}_1 \\boxminus \\mathbf{R}_2 \\\\ \\mathbf{a} - \\mathbf{b} \\end{bmatrix}$$From the above definition, it is easy to verify that\n$$ (\\mathbf{x} \\boxminus \\mathbf{u}) \\boxplus \\mathbf{x} = \\mathbf{u}; \\quad \\mathbf{x} \\boxplus (\\mathbf{y} \\boxminus \\mathbf{x}) = \\mathbf{y}; \\quad \\forall \\mathbf{x}, \\mathbf{y} \\in \\mathcal{M}, \\quad \\forall \\mathbf{u} \\in \\mathbb{R}^n.$$Continuous Motion Model In this section, we resort to the structure described in [4]. Thus, we set the position, acceleration, and angular velocity as measurable variables. The states are, the rotation matrix, $\\mathbf{R}$, the position, $\\mathbf{p}$, linear velocity, $\\mathbf{v}$, linear acceleration, $\\mathbf{a}$, angular velocity, $\\boldsymbol{\\omega}$, bias of IMU linear acceleration, $\\mathbf{b}_a$, bias of IMU angular velocity, $\\mathbf{b}_w$, and no control variables are employed.\nCoordinate alignment In this subsection, we explore the relationship between the linear acceleration and angular velocity of two points within a rigid body.\nAssume there are two points $\\mathbf{x}(t)$ and $\\mathbf{y}(t)$. They are attached rigidly. The point $\\mathbf{y}(t)$ is the in the $\\mathbf{r}$ direction under the coordinate of the $\\mathbf{x}$ point. The rotation of $\\mathbf{x}$ and $\\mathbf{y}$ are $\\mathbf{R}_x(t)$ and $\\mathbf{R}_y(t)$, respectively. Under the rigid attachment constraint and assume the extrinsic of $\\mathbf{y}(t)$ with respect to $\\mathbf{x}(t)$ is $(\\mathbf{R}, \\mathbf{r})$, we have:\n$$\\mathbf{y}(t) = \\mathbf{x}(t)+\\mathbf{R}_x(t)\\mathbf{r}\\tag{1}$$$$\\mathbf{R}_y(t)=\\mathbf{R}_x(t)\\mathbf{R}\\tag{2}$$Recall the representation of the IMU measurements we have\n$$\\dot{\\mathbf{R}}(t)=\\mathbf{R}(t)[\\boldsymbol{\\omega}]_\\times$$$$\\mathbf{y}''(t) = \\mathbf{R}_y(t)\\mathbf{a}_y\\\\ \\mathbf{x}''(t) = \\mathbf{R}_x(t)\\mathbf{a}_x$$where $\\boldsymbol{\\omega}$ is the IMU angular velocity measurements, $\\mathbf{a}_x$ and $\\mathbf{a}_y$ denote the IMU measured accelerations. Taking derivative of Eq. (2) with respect to $t$ we have:\n$$\\dot{\\mathbf{R}}_y(t) = \\dot{\\mathbf{R}}_x(t)\\mathbf{R}$$and\n$$ \\mathbf{R}_y(t)[\\boldsymbol{\\omega}_y]_{\\times} = \\mathbf{R}_x(t)[\\boldsymbol{\\omega}_x]_{\\times} \\mathbf{R} $$Substitute (2) we have\n$$ [\\boldsymbol{\\omega}_x]_{\\times} = \\mathbf{R}[\\boldsymbol{\\omega}_y]_{\\times} \\mathbf{R}^\\top. $$$$[\\boldsymbol{\\omega}]_\\times\\mathbf{v} = \\boldsymbol{\\omega}\\times \\mathbf{v}$$ we have\n$$\\begin{aligned} \\mathbf{R}[\\boldsymbol{\\omega}]_\\times\\mathbf{R}^\\top\\mathbf{v} \u0026= \\mathbf{R}[\\boldsymbol{\\omega}\\times\\left(\\mathbf{R}^\\top\\mathbf{v}\\right)] \\\\ \u0026\\overset{(a)}{=} (\\mathbf{R}\\boldsymbol{\\omega})\\times \\mathbf{v}\\\\ \u0026=[\\mathbf{R}\\boldsymbol{\\omega}]_\\times \\mathbf{v} \\end{aligned}$$where (a) establishes due to\n$$ \\mathbf{R}(\\mathbf{a}\\times\\mathbf{b}) = (\\mathbf{R}\\mathbf{a})\\times (\\mathbf{R}\\mathbf{b}) $$So, we have\n$$ \\boldsymbol{\\omega}_x = \\mathbf{R}\\boldsymbol{\\omega}_y\\tag{3} $$Thus we conclude that the measured angular velocity can be directly transformed from point $\\mathbf{y}$ to point $\\mathbf{x}$ only by a rotation. It does not depend on other parameters, e.g., the translation.\nAccording to Eq. (1), we have\n$$\\mathbf{x}'' = \\mathbf{y}'' - \\mathbf{R}_x''\\mathbf{r}$$And according to (2),\n$$\\begin{aligned} \\mathbf{R}_x'' \u0026= (\\mathbf{R}_x[\\boldsymbol{\\omega}_x]_\\times)'\\\\ \u0026= \\mathbf{R}_x'[\\boldsymbol{\\omega}_x]_\\times + \\mathbf{R}_x[\\boldsymbol{\\omega}_x']_\\times \\\\ \u0026= \\mathbf{R}_x[\\boldsymbol{\\omega}_x]_\\times^2 + \\mathbf{R}_x[\\boldsymbol{\\omega}_x']_\\times \\end{aligned}$$So, we have\n$$\\mathbf{R}_x \\mathbf{a}_x =\\mathbf{R}_y\\mathbf{a}_y - \\left( \\mathbf{R}_x[\\boldsymbol{\\omega}_x]_\\times^2 + \\mathbf{R}_x[\\boldsymbol{\\omega}_x']_\\times \\right)\\mathbf{r}$$which leads to\n$$\\mathbf{a}_x = \\mathbf{R}\\mathbf{a}_y - \\left([\\boldsymbol{\\omega}_x]_\\times^2+[\\boldsymbol{\\omega}'_x]_\\times\\right)\\mathbf{r}$$If we assume $\\boldsymbol{\\omega}_x'=\\mathbf{0}$, we have\n$$\\mathbf{a}_x =\\mathbf{R}\\mathbf{a}_y - [\\boldsymbol{\\omega}_x]_\\times^2 \\mathbf{r}\\tag{4}.$$This gives us the interesting result that\n$$\\mathbf{a}_y =\\mathbf{R}^\\top\\left(\\mathbf{a}_x +[\\boldsymbol{\\omega}_x]_\\times^2 \\mathbf{r}\\right) $$It indicates that the linear acceleration of the point of $\\mathbf{y}$ comprises two parts: the linear acceleration of point $\\mathbf{x}$; and the angular velocity of $\\mathbf{x}$, which is proportional to the length $\\mathbf{r}$.\nIn summary, Eq. (3) and Eq. (4) give the linear acceleration and angular velocity relationships between the two points in the rigid body system.\nIn the following, we assume the IMU measurements are aligned with ego-car coordinates.\nModel Dynamics Nominal Dynamic Model The ego-car kinematic model is\n$$ \\begin{aligned} \\dot{\\mathbf{p}} \u0026= \\, \\mathbf{v}\\\\ \\dot{\\mathbf{v}} \u0026= \\mathbf{R}\\mathbf{a}, \\\\ \\dot{\\mathbf{a}} \u0026= \\mathbf{0}\\\\ \\dot{\\mathbf{R}} \u0026= \\mathbf{R} \\left\\lfloor \\boldsymbol{\\omega} \\right\\rfloor_\\times\\\\ \\dot{\\boldsymbol{\\omega}} \u0026= \\mathbf{0},\\\\ \\dot{\\mathbf{b}_a}\u0026=\\mathbf{0},\\\\ \\dot{\\mathbf{b}}_w \u0026= \\mathbf{0}. \\end{aligned} $$where the state is defined as $\\mathbf{x}=[\\mathbf{R}^\\top,\\boldsymbol{\\omega}^\\top, \\mathbf{p}^\\top, \\mathbf{v}^\\top, \\mathbf{a}^\\top, \\mathbf{b}_a^\\top, \\mathbf{b}_w^\\top]^\\top$, and $\\mathbf{x}\\in SO(3)\\times\\mathbb{R}^{18}$. We should note that $\\mathbf{p}$, $\\mathbf{v}$, $\\mathbf{R}$ is defined on the global coordinate, while $\\mathbf{a}$, $\\boldsymbol{\\omega}$, $\\mathbf{b}_a$, $\\mathbf{b}_w$ is defined in the body (local) coordinate.\nBicycle Model Another popular kinematic model is the bicycle model. If more advanced kinematic model is needed, please refere to [10].\nObservation Model Let $\\mathbf{y} = [\\mathbf{y}_p^\\top, \\mathbf{y}_v^\\top, \\mathbf{y}_a^\\top, \\mathbf{y}_{\\omega}^\\top]^\\top$, where $\\mathbf{y}_p, \\mathbf{y}_v, \\mathbf{y}_a, \\mathbf{y}_{\\omega}$ denote the observed position, linear velocity, linear acceleration, and angular velocity, respectively.\nWheel Encoder Observation Assume the left and right wheel speeds are $v_1$, $v_2$, respectively. Denote $L$ as the wheel base. So, the vehicle speed, $v$, and rotation velocity, $\\omega$, are\n$v = \\frac{v_1+v_2}{2}$, and $\\omega = 2\\frac{v_2 - v_1}{L}$\non the moving plane. Assume the moving plane normal is $\\mathbf{n}_p$, and the moving direction is $\\mathbf{d}_p$. Then the measured velocity is $\\mathbf{y}_v = v\\mathbf{d}_p$ and the angular velocity is $\\mathbf{y}_w = w\\mathbf{n}_p$. Usually, the moving direction and plane normal are aligned with one of the ego’s coordinate axes.\nVelocity Measurements When measured by wheel encoder, the measurements is on the body coordinate. If the velocity is from the GPS or RTK, the velocity is on the global coordinate.\nThe Gravity The gravity can be estimated according to the [online calculator]\n$$ IGF = 9.780327 \\left(1 + 0.0053024\\sin^2(2\\Phi) - 0.0000058\\sin^2(2\\Phi)\\right) $$$$FAC = -3.086 \\times 10^{-6} \\times h$$$$g = IGF + FAC$$Then, in our model, we do not need to estimate gravity. Instead, we use this approximation.\nFurther, the direction of gravity, $\\mathbf{e}_g$, can also be estimated according to the GPS signal.\nSummary We have the continuous observation model:\n$$ \\mathbf{y}_p = \\mathbf{p} + \\boldsymbol{\\varepsilon}_p, $$$$ \\mathbf{y}_v = \\mathbf{R}\\mathbf{v} + \\boldsymbol{\\varepsilon}_v, $$or\n$$ \\mathbf{y}_v = \\mathbf{v} + \\boldsymbol{\\varepsilon}_v $$$$ \\mathbf{y}_a =\\left(\\mathbf{a}+\\mathbf{b}_a\\right) + \\mathbf{g} + \\boldsymbol{\\varepsilon}_a $$$$ \\mathbf{y}_\\omega = \\boldsymbol{\\omega} + \\mathbf{b}_w+ \\boldsymbol{\\varepsilon}_w $$where $\\mathbf{g} = g\\mathbf{e}_g$ is gravity vector, and $\\mathbf{e}_g$ is the gravity direction in the world coordinate and can be approximated according to GPS. If we move around a small local area, it can be further simplified as constant downwards to the earth center.\nDiscretize the Model We follow a continuous-discrete extended Kalman filter, where we do the two steps\nContinuous-Time Prediction: Between measurements, the state estimate and error covariance are propagated continuously using differential equations\nDiscrete-Time Update: When a measurement becomes available, the filter performs a discrete update step to incorporate the new information\nContinuous Motion Model Since using continuous/discrete EKF, we do not need to discretize the motion model explicitly. However, linearization is necessary to propagate the process noise.\nPlease refer to the appendix for the details of solving the ordinal differential equation and linearization. $T$ denotes the time interval between $t_{k+1}$ and $t_k$.\n$$ \\begin{aligned} \\mathbf{R}_{k+1} \u0026= \\mathbf{R}_k\\boxplus (T\\boldsymbol{\\omega}_k + \\frac{1}{2}T^2\\boldsymbol{\\varepsilon}_w)\\\\ \\boldsymbol{\\omega}_{k+1} \u0026= \\boldsymbol{\\omega}_k + T\\boldsymbol{\\varepsilon}_w\\\\ \\mathbf{p}_{k+1} \u0026= \\mathbf{p}_k + \\mathbf{v}_kT + \\frac{1}{2}\\mathbf{R}\\mathbf{a}_kT^2+\\frac{1}{6}T^3\\mathbf{R}\\boldsymbol{\\varepsilon}_a,\\\\ \\mathbf{v}_{k+1} \u0026= \\mathbf{v}_k +\\mathbf{R}\\mathbf{a}_kT + \\frac{1}{2}T^2\\mathbf{R}\\boldsymbol{\\varepsilon}_a,\\\\ \\mathbf{a}_{k+1} \u0026= \\mathbf{a}_k + T\\boldsymbol{\\varepsilon}_a,\\\\ \\mathbf{b}^w_{k+1} \u0026= \\mathbf{b}^w_k + T\\boldsymbol{\\epsilon}_{b_w},\\\\ \\mathbf{b}_{k+1}^a \u0026= \\mathbf{b}_k^a + T\\boldsymbol{\\epsilon}_{b_a} \\end{aligned} $$and we denote it as\n$$ \\mathbf{x}_{k+1} = f(\\mathbf{x}_k, \\boldsymbol{\\varepsilon}_k) $$Linearize the Motion Model The linear motion part is already a linear function. We only need to consider the rotation part.\nLet us define $\\mathbf{F}_x = \\mathbf{J}^f_{\\mathbf{x}}$ and $\\mathbf{F}_\\varepsilon = \\mathbf{J}^f_{\\boldsymbol{\\varepsilon}}$, where $\\mathbf{J}^f_\\mathbf{x}$ and $\\mathbf{J}^f_{\\boldsymbol{\\varepsilon}}$ indicates the Jacobian of $f$ with respect to $\\mathbf{x}$ and $\\boldsymbol{\\varepsilon}$, respectively.\nAccording to [1], for $\\mathbf{R}\\in SO(3)$, $\\mathbf{J}^{\\mathbf{R}\\boxplus\\boldsymbol{\\theta}}_{\\mathbf{R}} = \\mathbf{R}(\\boldsymbol{\\theta})^\\top$ and $\\mathbf{J}^{\\mathbf{R}\\boxplus\\boldsymbol{\\theta}}_{\\boldsymbol{\\theta}} = \\mathbf{J}_r(\\boldsymbol{\\theta})$, $\\mathbf{R}(\\boldsymbol{\\theta}) = \\text{Exp}(\\theta \\mathbf{u}) \\triangleq \\mathbf{I} + \\sin\\theta[\\mathbf{u}]_\\times + (1-\\cos\\theta)[\\mathbf{u}]_\\times^2$, $\\mathbf{J}_r(\\boldsymbol{\\theta}) \\triangleq \\mathbf{I} - \\frac{1 - \\cos \\theta}{\\theta^2} [\\boldsymbol{\\theta}]_{\\times} + \\frac{\\theta - \\sin \\theta}{\\theta^3} [\\boldsymbol{\\theta}]_{\\times}^2$.\n$$ \\mathbf{F}_x = \\begin{bmatrix} \\mathbf{R}(T\\boldsymbol{\\omega}+\\frac{1}{2}T^2\\boldsymbol{\\varepsilon}_w)^\\top \u0026 T\\mathbf{J}_r(T\\boldsymbol{\\omega}+\\frac{1}{2}T^2\\boldsymbol{\\varepsilon}_w) \u0026 \\mathbf{0}\u0026\\mathbf{0} \u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026\\mathbf{I}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0} \u0026\\mathbf{0} \u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{I}\u0026T\\mathbf{I}\u0026\\frac{1}{2}T^2\\mathbf{I}\u0026\\mathbf{0}\u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{I}\u0026T\\mathbf{I}\u0026\\mathbf{0}\u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{I}\u0026\\mathbf{0}\u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026\\mathbf{0} \u0026\\mathbf{0} \u0026\\mathbf{0} \u0026\\mathbf{0} \u0026T\\mathbf{I} \u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026T\\mathbf{I} \\end{bmatrix}, $$And\n$$ \\mathbf{F}_\\varepsilon = \\begin{bmatrix} \\frac{1}{2}T^2\\mathbf{J}_r(T\\boldsymbol{\\omega}+\\frac{1}{2}T^2\\boldsymbol{\\varepsilon}_w)\u0026\\mathbf{0}\u0026\\mathbf{0}\\\\ T\\mathbf{I}\u0026\\mathbf{0}\u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026\\frac{1}{6}T^3\\mathbf{I}\u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026\\frac{1}{2}T^2\\mathbf{I}\u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026T\\mathbf{I}\u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026\\mathbf{0}\u0026T\\mathbf{I}\\\\ \\mathbf{0}\u0026\\mathbf{0}\u0026T\\mathbf{I} \\end{bmatrix} $$Then, the discrete motion model can be linearly approximated as\n$$ \\begin{equation*} \\mathbf{x}_{k+1} \\approx f(\\hat{\\mathbf{x}}_k, \\mathbf{0})+ \\mathbf{F}_{x}|_{\\mathbf{\\mathbf{x}}=\\hat{\\mathbf{x}}_k, \\boldsymbol{\\varepsilon=\\mathbf{0}}}\\cdot(\\mathbf{x}_k-\\hat{\\mathbf{x}}_{k})+\\mathbf{F}_{\\varepsilon}|_{\\mathbf{\\mathbf{x}}=\\hat{\\mathbf{x}}_k, \\boldsymbol{\\varepsilon=\\mathbf{0}}}\\cdot\\boldsymbol{\\varepsilon}_k \\end{equation*} $$Discretize the Observation Model $$ \\begin{aligned} \\mathbf{y}_\\omega^k \u0026=\\boldsymbol{\\omega}^k +\\mathbf{b}_w^k + \\boldsymbol{\\varepsilon}_w^k,\\\\ \\mathbf{y}_p^k \u0026= \\mathbf{p}^k + \\boldsymbol{\\varepsilon}_p^k\\\\ \\mathbf{y}_v^k \u0026= \\mathbf{R}^k\\mathbf{v}^k + \\boldsymbol{\\varepsilon}_v^k, \\text{ or } \\mathbf{y}_v^k \u0026= \\mathbf{v}^k + \\boldsymbol{\\varepsilon}_v^k\\\\ \\mathbf{y}_a^k \u0026=\\mathbf{a}^k+\\mathbf{b}_a^k + \\mathbf{g} + \\boldsymbol{\\varepsilon}_a^k \\end{aligned} $$And compactly denote it as\n$$ \\mathbf{y}_k=h(\\mathbf{x}_k,\\boldsymbol{\\varepsilon}_k). $$Linearize the Observation Model Also, let $\\mathbf{H}_x = \\mathbf{J}^h_x$ and $\\mathbf{H}_\\varepsilon = \\mathbf{J}^h_\\varepsilon$ represent the Jacobian of $h$ with respect to $\\mathbf{x}$ and $\\boldsymbol{\\epsilon}$, respectively. We have\n$$ \\mathbf{H}_x = \\begin{bmatrix} \\mathbf{0}\u0026\\mathbf{I}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0} \u0026\\mathbf{I} \u0026\\mathbf{0}\\\\ \\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{I}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\\\\ -\\mathbf{R}[\\mathbf{v}]_\\times\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{I}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\\\\ -\\mathbf{R}[\\mathbf{a}+\\mathbf{b}_a]_\\times\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{0}\u0026\\mathbf{I} \u0026\\mathbf{0} \u0026\\mathbf{I} \\end{bmatrix}, $$where we use the identity $\\mathbf{J}^{\\mathbf{R}\\boldsymbol{\\theta}}_{\\mathbf{R}} = -\\mathbf{R}[\\boldsymbol{\\theta}]_\\times$,\n$$ [\\boldsymbol{\\theta}]_\\times= \\begin{bmatrix} 0\u0026-\\theta_z\u0026\\theta_y\\\\ \\theta_z\u00260\u0026-\\theta_x\\\\ -\\theta_y\u0026\\theta_x\u00260 \\end{bmatrix} $$and\n$$ \\mathbf{H}_\\varepsilon = \\begin{bmatrix} \\mathbf{I}\\\\ \\mathbf{I}\\\\ \\mathbf{I}\\\\ \\mathbf{I} \\end{bmatrix} $$Thus, the observation model can be linearized as\n$$ \\begin{equation*} \\mathbf{y}_k \\approx h(\\mathbf{x}_{k|k-1}, \\mathbf{0}) + \\mathbf{H}_x|_{\\mathbf{x}=\\mathbf{x}_{k|k-1},\\boldsymbol{\\varepsilon}=\\mathbf{0}}\\cdot(\\mathbf{x}_k-\\mathbf{x}_{k|k-1}) + \\mathbf{H}_\\varepsilon|_{\\mathbf{x}=\\mathbf{x}_{k|k-1},\\boldsymbol{\\varepsilon}=\\mathbf{0}}\\cdot\\boldsymbol{\\varepsilon}_k \\end{equation*} $$Iterative Extended Kalman Filter This section shows how the iterative extended Kalman filter’s update steps\nPredict Step Given last time estimation $\\mathbf{x}_{k-1} \\sim \\mathcal{N}(\\hat{\\mathbf{x}}_{k-1}, \\hat{\\mathbf{P}}_{k-1})$\nUpdate state: $\\mathbf{x}_{k|k-1} = f(\\hat{\\mathbf{x}}_{k-1}, \\mathbf{0})$\nUpdate covariance: $\\mathbf{P}_{k|k-1} = \\mathbf{F}_x\\hat{\\mathbf{P}}_{k-1}\\mathbf{F}_x^\\top+\\mathbf{F}_{\\varepsilon}\\mathbf{Q}_{\\varepsilon}\\mathbf{F}_{\\varepsilon}^\\top$\nwhere $\\mathbf{Q}_{\\varepsilon}$ is the process noise covariance.\nCorrect Step Iterate\nUpdate gain: $\\mathbf{K}_k = \\mathbf{P}_{k|k-1}\\mathbf{H}_x^\\top\\left(\\mathbf{H}_x\\mathbf{P}_{k|k-1}\\mathbf{H}_x^\\top+\\mathbf{H}_\\varepsilon\\mathbf{R}_k\\mathbf{H}_\\varepsilon^\\top\\right)^{-1}$\nUpdate mean: $\\hat{\\mathbf{x}}_k = \\mathbf{x}_{k|k-1} \\boxplus \\mathbf{K}_k\\left(\\mathbf{y}_k\\boxminus h(\\mathbf{x}_{k|k-1},\\mathbf{0})\\right)$\nUpdate covariance: $\\hat{\\mathbf{P}}_{k} = \\left(\\mathbf{I}-\\mathbf{K}_k\\mathbf{H}_x\\right)\\mathbf{P}_{k|k-1}$\nIf converged: break; else: substitute the new updates into (2) , get the new $\\mathbf{H}_x$ and $\\mathbf{H}_\\varepsilon$, and repeat the correcting step.\nNote We may only have parts of the observations. So, revise the $\\mathbf{H}_x$ accordingly.\nWhen updating the $\\mathbf{p}$ and $\\boldsymbol{\\omega}$individually or combine, we do not need to iterate the correcting step. Since it is already a linear observation.\nCompared with the traditional iterative extended Kalman filter, the only difference lies in the the mean updating step, where we substitute $\\boxplus$ with $+$. Since $\\mathbf{y}_k\\in \\mathbb{R}^{12}$, so $\\boxminus$ can be replaced by $-$.\nImplementations There are three ways to describe a rotation: axis-angle, matrix, and quaternion. In this section, we will explore their relationships and its numerical stability when implementation. [8]\nAxis-angle to matrix The Exponential map\n$$\\begin{aligned} \\text{Exp} : \\mathbb{R}^3 \u0026 \\longrightarrow \\text{SO}(3) \\\\ \\boldsymbol{\\omega} \u0026 \\longmapsto \\mathbb{R}_{3 \\times 3} \\end{aligned}$$Rodrigues’ formula\n$$\\text{Exp}(\\boldsymbol{\\omega}) \\triangleq \\mathbf{R}(\\mathbf{n},\\theta) =\\mathbf{I} + \\sin\\theta[\\mathbf{n}]_\\times + (1-\\cos\\theta)[\\mathbf{n}]_\\times^2,$$where $\\boldsymbol{\\omega} = \\theta\\mathbf{n}$, and $\\theta= \\|\\boldsymbol{\\omega}\\|$.\n$$ \\mathbf{R}(\\mathbf{n}, \\theta) = \\begin{pmatrix} \\cos \\theta + n_1^2 (1 - \\cos \\theta) \u0026 n_1 n_2 (1 - \\cos \\theta) - n_3 \\sin \\theta \u0026 n_1 n_3 (1 - \\cos \\theta) + n_2 \\sin \\theta \\\\ n_1 n_2 (1 - \\cos \\theta) + n_3 \\sin \\theta \u0026 \\cos \\theta + n_2^2 (1 - \\cos \\theta) \u0026 n_2 n_3 (1 - \\cos \\theta) - n_1 \\sin \\theta \\\\ n_1 n_3 (1 - \\cos \\theta) - n_2 \\sin \\theta \u0026 n_2 n_3 (1 - \\cos \\theta) + n_1 \\sin \\theta \u0026 \\cos \\theta + n_3^2 (1 - \\cos \\theta) \\end{pmatrix}. $$Axis-angle to Quaternion The exponential map can also be directly mapped as a unit quaternion $[q_r, \\, q_x, \\, q_y, \\, q_z]^\\top$:\n$$ e^{\\omega}_q = \\begin{cases} (1, 0, 0, 0)^\\top, \u0026 \\text{if } \\boldsymbol{\\omega} = (0, 0, 0)^\\top \\\\ \\left( \\cos \\frac{|\\boldsymbol{\\omega}|}{2}, \\sin \\frac{|\\boldsymbol{\\omega}|}{2} \\frac{\\boldsymbol{\\omega}}{|\\boldsymbol{\\omega}|} \\right)^\\top, \u0026 \\text{otherwise} \\end{cases} $$Matrix to Axis-angle $$\\begin{equation} \\cos \\theta = \\frac{1}{2} (\\text{tr}(\\mathbf{R}) - 1)\\\\ \\sin \\theta = \\left(1 - \\cos^2 \\theta \\right)^{1/2} = \\frac{1}{2} \\sqrt{(3 - \\text{tr}(\\mathbf{R}))(1 + \\text{tr}(\\mathbf{R}))} \\end{equation}$$where $\\sin \\theta \\geq 0$ is a consequence of the convention for the range of the rotation angle, $\\theta \\in [0, \\pi]$.\nThen from Rodrigues’ formula and Taylor approximation it follows that logarithmic map can be implemented as follows:\n$$\\begin{aligned} \\boldsymbol{\\omega} \u0026= \\text{Log}(\\mathbf{R}) =\\left[\\log(\\mathbf{R})\\right]^\\vee = \\frac{\\theta}{2 \\sin \\theta} \\left[\\mathbf{R} - \\mathbf{R}^\\top\\right]^\\vee \\\\ \u0026 = \\frac{\\theta}{2 \\sin \\theta} (R_{32} - R_{23}, R_{13} - R_{31}, R_{21} - R_{12})^\\top,\\\\ \\boldsymbol{\\omega} \u0026= 0.5 \\cdot \\left(1 + \\frac{\\theta^2}{6} + \\frac{7}{360} \\theta^4\\right) \\left[\\mathbf{R} - \\mathbf{R}^\\top\\right]^\\vee, \\quad \\text{if } \\text{abs}(3 - \\text{tr}(\\mathbf{R})) \u003c 10^{-8}. \\end{aligned}$$The above implementation is the most common, however, it diverges at a special case when the angle of rotation $\\theta$ is close to $\\pi$. Nevertheless, it is possible to describe the log map at these edge cases when $\\sin\\theta = 0$, that is $\\theta = 0$ or $\\theta = \\pi$. In both cases $R_{ij} = R_{ji}$, and $\\boldsymbol{\\omega}$ can not be determined by the above equations. However, the angle $\\theta$ is derived from eq. (3) , and inserting it into Rodrigues’ formula :\n$$\\frac{\\boldsymbol{\\omega}}{|\\boldsymbol{\\omega}|} = \\mathbf{n} = \\begin{cases} \\left(\\epsilon_1 \\sqrt{\\frac{1}{2}(1 + R_{11})}, \\epsilon_2 \\sqrt{\\frac{1}{2}(1 + R_{22})}, \\epsilon_3 \\sqrt{\\frac{1}{2}(1 + R_{33})}\\right)^\\top, \u0026 \\text{if } \\theta = \\pi \\\\ (0, 0, 0), \u0026 \\text{if } \\theta = 0 \\end{cases}$$where the individual signs $\\epsilon_i = \\pm 1$ (if $n_i \\neq 0$) are determined up to an overall sign (since $\\mathbf{R}(\\mathbf{n}, \\pi) = \\mathbf{R}(\\mathbf{n}, -\\pi)$) via the following relation:\n$$\\epsilon_i \\epsilon_j = \\frac{R_{ij}}{\\sqrt{(1 + R_{ii})(1 + R_{jj})}}, \\quad \\text{for } i \\neq j, R_{ii} \\neq -1, R_{jj} \\neq -1$$Matrix to Quaternion The transformation from rotation matrix $\\mathbf{R}$ to quaternion $\\mathbf{q} = (q_r \\, q_x \\, q_y \\, q_z)^\\top = (q_r, \\mathbf{q}_v^\\top)^\\top$ is well-defined for all angles due to resolving ambiguities through case differentiation.\n$$\\begin{aligned} \u0026\\text{if } \\text{tr}(\\mathbf{R}) \u003e 0 \\\\ \u0026t = \\sqrt{1 + \\text{tr}(\\mathbf{R})}, \\quad q_r = 0.5 \\cdot t, \\quad \\mathbf{q}_v = 0.5 / t \\cdot (\\mathbf{R} - \\mathbf{R}^\\top)^\\vee \\quad \\quad \\quad \\\\ \u0026\\text{else if } R_{11} \\geq R_{22}, \\; R_{11} \\geq R_{33} \\\\ \u0026t = \\sqrt{1 + R_{11} - R_{22} - R_{33}}, \\quad q_x = 0.5 \\cdot t, \\\\ \u0026q_r = 0.5 / t \\cdot (R_{32} - R_{23}), \\quad q_y = 0.5 / t \\cdot (R_{21} + R_{12}), \\quad q_z = 0.5 / t \\cdot (R_{13} + R_{31}) \\quad \\\\ \u0026\\text{else if } R_{22} \u003e R_{11}, \\; R_{22} \\geq R_{33} \\\\ \u0026t = \\sqrt{1 + R_{22} - R_{33} - R_{11}}, \\quad q_y = 0.5 \\cdot t, \\\\ \u0026q_r = 0.5 / t \\cdot (R_{13} - R_{31}), \\quad q_z = 0.5 / t \\cdot (R_{12} + R_{21}), \\quad q_x = 0.5 / t \\cdot (R_{23} + R_{32}) \\quad \\\\ \u0026\\text{else if } R_{33} \u003e R_{11}, \\; R_{33} \u003e R_{22} \\\\ \u0026t = \\sqrt{1 + R_{33} - R_{11} - R_{22}}, \\quad q_z = 0.5 \\cdot t, \\\\ \u0026q_r = 0.5 / t \\cdot (R_{21} - R_{12}), \\quad q_x = 0.5 / t \\cdot (R_{32} + R_{23}), \\quad q_y = 0.5 / t \\cdot (R_{31} + R_{13}) \\quad \\end{aligned}$$Quaternion to Axis-angle The logarithm map can be directly given from a unit quaternion $\\mathbf{q} = (q_r \\, q_x \\, q_y \\, q_z)^\\top = (q_r, \\mathbf{q}_v^\\top)^\\top$:\n$$\\begin{aligned} \u0026\\log : \\text{SO}(3) \\longrightarrow \\mathfrak{so}(3) \\\\ \u0026\\text{SU}(2) \\longrightarrow \\boldsymbol{\\omega} \\end{aligned}$$and\n$$ \\boldsymbol{\\omega} = 2 \\arccos(q_r) \\frac{\\mathbf{q}_v}{\\|\\mathbf{q}_v\\|_2}. $$ Or the numerically more stable implementation:\n$$ \\begin{aligned} \\mathbf{q} \u0026= \\text{sign}(q_r) \\mathbf{q}\\\\ \\boldsymbol{\\omega} \u0026= \\left( \\frac{2}{q_r} - \\frac{2}{3} \\cdot \\frac{\\|\\mathbf{q}_v\\|_2^2}{q_r^3} \\right) \\mathbf{q}_v, \\quad \\text{if } \\|\\mathbf{q}_v\\|_2 \u003c \\epsilon \\\\ \\boldsymbol{\\omega} \u0026= 4 \\arctan \\left( \\frac{\\|\\mathbf{q}_v\\|_2}{q_r + \\sqrt{q_r^2 + \\|\\mathbf{q}_v\\|_2^2}} \\right) \\cdot \\frac{\\mathbf{q}_v}{\\|\\mathbf{q}_v\\|_2}, \\quad \\text{else} \\end{aligned} $$Quaternion to Matrix $$\\mathbf{R}(\\mathbf{q}) = \\begin{bmatrix} w^2 + x^2 - y^2 - z^2 \u0026 2(xy - wz) \u0026 2(xz + wy) \\\\ 2(xy + wz) \u0026 w^2 - x^2 + y^2 - z^2 \u0026 2(yz - wx) \\\\ 2(xz - wy) \u0026 2(yz + wx) \u0026 w^2 - x^2 - y^2 + z^2 \\end{bmatrix}$$Appendix Discretize the Model Solving the General Form of the Differential Equation “Differential Equations and Linear Algebra”, Theorem 11.45 (first order) [6]\n$$\\mathbf{x}^\\prime(t) = \\mathbf{A} \\mathbf{x}(t) + \\mathbf{f}(t), \\quad \\mathbf{x}(t_0) = \\mathbf{x}_0$$The solution to this system is\n$$ \\mathbf{x}(t) = e^{\\mathbf{A}t}\\mathbf{x}(t_0) + e^{\\mathbf{A}t}\\int_{t_0}^{t} e^{-s\\mathbf{A}}\\mathbf{f}(s)ds \\tag{5} $$where $e^{\\mathbf{A}t}=\\sum_{k=0}^{\\infty}\\mathbf{A}^k\\frac{t^k}{k!}$.\nDiscretization of Linear State-Space Model Refer to the wiki page Discretization and “Introduction to Random Signals and Applied Kalman filtering”, Chapter 5.3 [11] for more details.\n$$\\dot{x}(t) = Ax(t) + Bu(t)$$Substitute $t_0=kT$, $\\mathbf{x}[k] = \\mathbf{x}(t_0)$ and $\\mathbf{x}[k+1] = \\mathbf{x}((k+1)T)$ into Eq. (5), we have\n$$\\begin{aligned} x[k+1] \u0026= e^{AT} x[k] + \\left( \\int_0^T e^{Av} \\, dv \\right) Bu[k] \\\\ \u0026= \\left( \\sum_{k=0}^{\\infty} \\frac{1}{k!} (AT)^k \\right) x[k] + \\left( \\sum_{k=1}^{\\infty} \\frac{1}{k!} A^{k-1}T^k \\right) Bu[k] \\end{aligned} \\tag{6}$$Please refer to the wiki page Matrix exponential for how to compute or approximate matrix exponential.\nAlternative discretization approaches such as the forward Euler method, backward Euler method, and bilinear transform are also viable options depending on accuracy requirements and computational constraints.\nExample Constant acceleration model, the hidden state is $\\mathbf{z} = [x, \\dot{x}, \\ddot{x}]$ and the state dynamic is $\\ddot{x} =0$, rewrite the state dynamic in first order differential equation as below\n$$\\begin{aligned} \\begin{bmatrix} x\\\\ \\dot{x}\\\\ \\ddot{x} \\end{bmatrix} \u0026= \\begin{bmatrix} 0 \u0026 1 \u0026 0\\\\ 0 \u0026 0 \u0026 1\\\\ 0 \u0026 0 \u0026 0 \\end{bmatrix} \\begin{bmatrix} x\\\\ \\dot{x}\\\\ \\ddot{x} \\end{bmatrix} + \\begin{bmatrix} 0 \\\\ 0\\\\ a \\end{bmatrix} \\\\ \u0026= \\mathbf{A}\\mathbf{z} + \\mathbf{u} \\end{aligned}$$where $a$ is the noise on the acceleration.\nAccording to Eq. (6), and note that $\\mathbf{A}^k = \\mathbf{0}$ when $k \u003e 2$, so we have\n$$\\begin{aligned} \\mathbf{z}_{k+1} \u0026= \\left(\\mathbf{I}+\\mathbf{A}T + \\frac{1}{2}\\mathbf{A}^2T^2\\right) \\mathbf{z}_k + \\left(\\mathbf{I}T + \\frac{1}{2}T^2\\mathbf{A} + \\frac{1}{6}\\mathbf{A}^2T^3\\right)\\mathbf{u} \\\\ \u0026= \\begin{bmatrix} 1 \u0026 T \u0026 \\frac{1}{2}T^2 \\\\ 0 \u0026 1 \u0026 T \\\\ 0 \u0026 0 \u0026 1 \\end{bmatrix} \\mathbf{z}_k + T \\begin{bmatrix} 1 \u0026 \\frac{T}{2} \u0026 \\frac{T^2}{6} \\\\ 0 \u0026 1 \u0026 \\frac{T}{2} \\\\ 0 \u0026 0 \u0026 1 \\end{bmatrix} \\mathbf{u}\\\\ \u0026= \\begin{bmatrix} x_k + \\dot{x}_kT + \\frac{1}{2}\\ddot{x}_kT^2 \\\\ \\dot{x}_k + \\ddot{x}_kT \\\\ \\ddot{x}_k \\end{bmatrix} + \\begin{bmatrix} \\frac{T^2}{6} \\\\ \\frac{T}{2} \\\\ 1 \\end{bmatrix} aT \\end{aligned}$$References [1] J. Solà, J. Deray, and D. Atchuthan, “A micro Lie theory for state estimation in robotics.” arXiv, Dec. 08, 2021. doi: 10.48550/arXiv.1812.01537.\n[2] W. Xu and F. Zhang, “FAST-LIO: A Fast, Robust LiDAR-inertial Odometry Package by Tightly-Coupled Iterated Kalman Filter.” arXiv, Apr. 14, 2021. Accessed: May 06, 2024. [Online]. Available: http://arxiv.org/abs/2010.08196\n[3] F. Bullo and R. M. Murray, “Proportional derivative (pd) control on the euclidean group,” in European control conference, vol. 2, 1995, pp. 1091–1097.\n[4] A. T. Erdem and A. O. Ercan, “Fusing Inertial Sensor Data in an Extended Kalman Filter for 3D Camera Tracking,” IEEE Trans. on Image Process., vol. 24, no. 2, pp. 538–548, Feb. 2015, doi: 10.1109/TIP.2014.2380176.\n[5] F. Shah, “Diﬀerential Equations Cheatsheet”.\n[6] G. Strang, Differential Equations and Linear Algebra. Wellesley, MA: Wellesley-Cambridge Press, 2014.\n[7] Extended Kalman Filter Tutorial\n[8] Z. Nurlanov, “Exploring SO(3) logarithmic map: degeneracies and derivatives”.\n[9] Extended Kalman Filter Lecture Notes\n[10] J. Kong, M. Pfeiffer, G. Schildbach, and F. Borrelli, “Kinematic and dynamic vehicle models for autonomous driving control design,” in 2015 IEEE Intelligent Vehicles Symposium (IV), Jun. 2015, pp. 1094–1099. doi: 10.1109/IVS.2015.7225830.\n[11] R. G. Brown and P. Y. C. Hwang, Introduction to Random Signals and Applied Kalman Filtering with MATLAB Exercises, 4th ed. Hoboken, NJ: Wiley, 2012.\n[12] Wikipedia contributors, “Discretization,” Wikipedia, The Free Encyclopedia, Jan. 2024. [Online]. Available: https://en.wikipedia.org/wiki/Discretization.\n","wordCount":"3073","inLanguage":"en","image":"https://livey.github.io/posts/2024-12-pose-tracking/%3Cimage%20path/url%3E","datePublished":"2024-12-24T00:00:00Z","dateModified":"2024-12-24T00:00:00Z","author":{"@type":"Person","name":"Fuwei Li"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://livey.github.io/posts/2024-12-pose-tracking/"},"publisher":{"@type":"Organization","name":"Fuwei's Tech Notes","logo":{"@type":"ImageObject","url":"https://livey.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://livey.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://livey.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://livey.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://livey.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://livey.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://livey.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://livey.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://livey.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Pose Tracking with Iterative Extended Kalman Filter</h1><div class=post-description>Pose Tracking with Iterative Extended Kalman Filter</div><div class=post-meta><span title='2024-12-24 00:00:00 +0000 UTC'>December 24, 2024</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;3073 words&nbsp;·&nbsp;Fuwei Li&nbsp;|&nbsp;<a href=https://github.com/livey/livey.github.io/issues/new rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#preliminaries aria-label=Preliminaries>Preliminaries</a></li><li><a href=#continuous-motion-model aria-label="Continuous Motion Model">Continuous Motion Model</a><ul><li><a href=#coordinate-alignment aria-label="Coordinate alignment">Coordinate alignment</a></li><li><a href=#model-dynamics aria-label="Model Dynamics">Model Dynamics</a><ul><li><a href=#nominal-dynamic-model aria-label="Nominal Dynamic Model">Nominal Dynamic Model</a></li><li><a href=#bicycle-model aria-label="Bicycle Model">Bicycle Model</a></li></ul></li><li><a href=#observation-model aria-label="Observation Model">Observation Model</a><ul><li><a href=#wheel-encoder-observation aria-label="Wheel Encoder Observation">Wheel Encoder Observation</a></li><li><a href=#velocity-measurements aria-label="Velocity Measurements">Velocity Measurements</a></li><li><a href=#the-gravity aria-label="The Gravity">The Gravity</a></li><li><a href=#summary aria-label=Summary>Summary</a></li></ul></li></ul></li><li><a href=#discretize-the-model aria-label="Discretize the Model">Discretize the Model</a><ul><li><a href=#continuous-motion-model-1 aria-label="Continuous Motion Model">Continuous Motion Model</a><ul><li><a href=#linearize-the-motion-model aria-label="Linearize the Motion Model">Linearize the Motion Model</a></li></ul></li><li><a href=#discretize-the-observation-model aria-label="Discretize the Observation Model">Discretize the Observation Model</a><ul><li><a href=#linearize-the-observation-model aria-label="Linearize the Observation Model">Linearize the Observation Model</a></li></ul></li></ul></li><li><a href=#iterative-extended-kalman-filter aria-label="Iterative Extended Kalman Filter">Iterative Extended Kalman Filter</a><ul><li><a href=#predict-step aria-label="Predict Step">Predict Step</a></li><li><a href=#correct-step aria-label="Correct Step">Correct Step</a></li><li><a href=#note aria-label=Note>Note</a></li></ul></li><li><a href=#implementations aria-label=Implementations>Implementations</a><ul><li><a href=#axis-angle-to-matrix aria-label="Axis-angle to matrix">Axis-angle to matrix</a></li><li><a href=#axis-angle-to-quaternion aria-label="Axis-angle to Quaternion">Axis-angle to Quaternion</a></li><li><a href=#matrix-to-axis-angle aria-label="Matrix to Axis-angle">Matrix to Axis-angle</a></li><li><a href=#matrix-to-quaternion aria-label="Matrix to Quaternion">Matrix to Quaternion</a></li><li><a href=#quaternion-to-axis-angle aria-label="Quaternion to Axis-angle">Quaternion to Axis-angle</a></li><li><a href=#quaternion-to-matrix aria-label="Quaternion to Matrix">Quaternion to Matrix</a></li></ul></li><li><a href=#appendix aria-label=Appendix>Appendix</a><ul><li><a href=#discretize-the-model-1 aria-label="Discretize the Model">Discretize the Model</a><ul><li><a href=#solving-the-general-form-of-the-differential-equation aria-label="Solving the General Form of the Differential Equation">Solving the General Form of the Differential Equation</a></li><li><a href=#discretization-of-linear-state-space-model aria-label="Discretization of Linear State-Space Model">Discretization of Linear State-Space Model</a></li><li><a href=#example aria-label=Example>Example</a></li></ul></li></ul></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>Tracking ego pose is critical in autonomous driving. In this article, we will discuss how to fuse the IMU, wheel encoder, GPS, etc. to track the ego pose. We will derive the pose tracking algorithm based on the iterative extended Kalman filter.
This document mainly follows [1] and [2].</p><h1 id=preliminaries>Preliminaries<a hidden class=anchor aria-hidden=true href=#preliminaries>#</a></h1><p>Let $\mathcal{M}$ be the manifold of dimension $n$ in consideration (e.g., $\mathcal{M} = SO(3)$). Since manifolds are locally homeomorphic to $\mathbb{R}^n$, we can establish a bijective mapping from a local neighborhood on $\mathcal{M}$ to its tangent space $\mathbb{R}^n$ via two encapsulation operators $\boxplus$ and $\boxminus$:</p>$$\boxplus : \mathcal{M} \times \mathbb{R}^n \to \mathcal{M};
\boxminus : \mathcal{M} \times \mathcal{M} \to \mathbb{R}^n$$$$
\text{for } \mathcal{M} = SO(3) : \mathbf{R} \boxplus \mathbf{r} = \mathbf{R} \text{Exp}(\mathbf{r});\quad \mathbf{R}_1 \boxminus \mathbf{R}_2 = \text{Log}(\mathbf{R}_2^T \mathbf{R}_1) $$$$\text{for }\mathcal{M} = \mathbb{R}^n : \mathbf{a} \boxplus \mathbf{b} = \mathbf{a} + \mathbf{b}; \quad \mathbf{a} \boxminus \mathbf{b} = \mathbf{a} - \mathbf{b}
$$<p>where $\text{Exp}(\cdot)$ is the exponential map and $\text{Log}(\cdot)$ is its inverse map.</p>$$\text{Exp}(\theta \mathbf{u})=\mathbf{R}(\boldsymbol{\theta})
\triangleq \mathbf{I} + \sin\theta[\mathbf{u} ]_\times + (1-\cos\theta)[\mathbf{u}]_\times^2,
$$$$[\boldsymbol{\theta}]_\times=
\begin{bmatrix}
0&-\theta_z&\theta_y\\
\theta_z&0&-\theta_x\\
-\theta_y&\theta_x&0
\end{bmatrix},
$$<p>where $\boldsymbol{\theta}= \theta\mathbf{u}$ and $\|\mathbf{u}\|=1$.</p>$$\mathcal{M} = SO(3) \times \mathbb{R}^n$$<p>we have:</p>$$\begin{bmatrix}
\mathbf{R} \\ \mathbf{a}
\end{bmatrix}
\boxplus
\begin{bmatrix}
\mathbf{r} \\ \mathbf{b}
\end{bmatrix} =
\begin{bmatrix}
\mathbf{R} \boxplus \mathbf{r} \\ \mathbf{a} + \mathbf{b}
\end{bmatrix};
\quad
\begin{bmatrix}
\mathbf{R}_1 \\ \mathbf{a}
\end{bmatrix}
\boxminus
\begin{bmatrix}
\mathbf{R}_2 \\ \mathbf{b}
\end{bmatrix} =
\begin{bmatrix}
\mathbf{R}_1 \boxminus \mathbf{R}_2 \\ \mathbf{a} - \mathbf{b}
\end{bmatrix}$$<p>From the above definition, it is easy to verify that</p>$$
(\mathbf{x} \boxminus \mathbf{u}) \boxplus \mathbf{x} = \mathbf{u}; \quad \mathbf{x} \boxplus (\mathbf{y} \boxminus \mathbf{x}) = \mathbf{y}; \quad \forall \mathbf{x}, \mathbf{y} \in \mathcal{M}, \quad \forall \mathbf{u} \in \mathbb{R}^n.$$<h1 id=continuous-motion-model>Continuous Motion Model<a hidden class=anchor aria-hidden=true href=#continuous-motion-model>#</a></h1><p>In this section, we resort to the structure described in [4]. Thus, we set the position, acceleration, and angular velocity as measurable variables. The states are, the rotation matrix, $\mathbf{R}$, the position, $\mathbf{p}$, linear velocity, $\mathbf{v}$, linear acceleration, $\mathbf{a}$, angular velocity, $\boldsymbol{\omega}$, bias of IMU linear acceleration, $\mathbf{b}_a$, bias of IMU angular velocity, $\mathbf{b}_w$, and no control variables are employed.</p><h2 id=coordinate-alignment>Coordinate alignment<a hidden class=anchor aria-hidden=true href=#coordinate-alignment>#</a></h2><p>In this subsection, we explore the relationship between the linear acceleration and angular velocity of two points within a rigid body.</p><div style="text-align:center;margin:0 auto;display:flex;justify-content:center"><img src=./resources/imu-alignment.png alt="IMU coordinate alignment" style=width:50%></div><p>Assume there are two points $\mathbf{x}(t)$ and $\mathbf{y}(t)$. They are attached rigidly. The point $\mathbf{y}(t)$ is the in the $\mathbf{r}$ direction under the coordinate of the $\mathbf{x}$ point. The rotation of $\mathbf{x}$ and $\mathbf{y}$ are $\mathbf{R}_x(t)$ and $\mathbf{R}_y(t)$, respectively. Under the rigid attachment constraint and assume the extrinsic of $\mathbf{y}(t)$ with respect to $\mathbf{x}(t)$ is $(\mathbf{R}, \mathbf{r})$, we have:</p>$$\mathbf{y}(t) = \mathbf{x}(t)+\mathbf{R}_x(t)\mathbf{r}\tag{1}$$$$\mathbf{R}_y(t)=\mathbf{R}_x(t)\mathbf{R}\tag{2}$$<p>Recall the representation of the IMU measurements we have</p>$$\dot{\mathbf{R}}(t)=\mathbf{R}(t)[\boldsymbol{\omega}]_\times$$$$\mathbf{y}''(t) = \mathbf{R}_y(t)\mathbf{a}_y\\
\mathbf{x}''(t) = \mathbf{R}_x(t)\mathbf{a}_x$$<p>where $\boldsymbol{\omega}$ is the IMU angular velocity measurements, $\mathbf{a}_x$ and $\mathbf{a}_y$ denote the IMU measured accelerations. Taking derivative of Eq. (2) with respect to $t$ we have:</p>$$\dot{\mathbf{R}}_y(t) = \dot{\mathbf{R}}_x(t)\mathbf{R}$$<p>and</p>$$
\mathbf{R}_y(t)[\boldsymbol{\omega}_y]_{\times} = \mathbf{R}_x(t)[\boldsymbol{\omega}_x]_{\times} \mathbf{R}
$$<p>Substitute (2) we have</p>$$
[\boldsymbol{\omega}_x]_{\times} = \mathbf{R}[\boldsymbol{\omega}_y]_{\times} \mathbf{R}^\top.
$$$$[\boldsymbol{\omega}]_\times\mathbf{v} = \boldsymbol{\omega}\times \mathbf{v}$$<p>we have</p>$$\begin{aligned}
\mathbf{R}[\boldsymbol{\omega}]_\times\mathbf{R}^\top\mathbf{v}
&=
\mathbf{R}[\boldsymbol{\omega}\times\left(\mathbf{R}^\top\mathbf{v}\right)] \\
&\overset{(a)}{=} 
(\mathbf{R}\boldsymbol{\omega})\times \mathbf{v}\\
&=[\mathbf{R}\boldsymbol{\omega}]_\times \mathbf{v}
\end{aligned}$$<p>where (a) establishes due to</p>$$
\mathbf{R}(\mathbf{a}\times\mathbf{b}) = (\mathbf{R}\mathbf{a})\times (\mathbf{R}\mathbf{b})
$$<p>So, we have</p>$$
\boldsymbol{\omega}_x = \mathbf{R}\boldsymbol{\omega}_y\tag{3}
$$<p>Thus we conclude that the measured angular velocity can be directly transformed from point $\mathbf{y}$ to point $\mathbf{x}$ only by a rotation. It does not depend on other parameters, e.g., the translation.</p><p>According to Eq. (1), we have</p>$$\mathbf{x}'' = \mathbf{y}'' - \mathbf{R}_x''\mathbf{r}$$<p>And according to (2),</p>$$\begin{aligned}
\mathbf{R}_x''
&= (\mathbf{R}_x[\boldsymbol{\omega}_x]_\times)'\\
&=
\mathbf{R}_x'[\boldsymbol{\omega}_x]_\times + \mathbf{R}_x[\boldsymbol{\omega}_x']_\times \\
&= 
\mathbf{R}_x[\boldsymbol{\omega}_x]_\times^2 + \mathbf{R}_x[\boldsymbol{\omega}_x']_\times
\end{aligned}$$<p>So, we have</p>$$\mathbf{R}_x \mathbf{a}_x =\mathbf{R}_y\mathbf{a}_y -
\left(
\mathbf{R}_x[\boldsymbol{\omega}_x]_\times^2 + \mathbf{R}_x[\boldsymbol{\omega}_x']_\times
\right)\mathbf{r}$$<p>which leads to</p>$$\mathbf{a}_x = \mathbf{R}\mathbf{a}_y - \left([\boldsymbol{\omega}_x]_\times^2+[\boldsymbol{\omega}'_x]_\times\right)\mathbf{r}$$<p>If we assume $\boldsymbol{\omega}_x'=\mathbf{0}$, we have</p>$$\mathbf{a}_x =\mathbf{R}\mathbf{a}_y - [\boldsymbol{\omega}_x]_\times^2
\mathbf{r}\tag{4}.$$<p>This gives us the interesting result that</p>$$\mathbf{a}_y =\mathbf{R}^\top\left(\mathbf{a}_x +[\boldsymbol{\omega}_x]_\times^2
\mathbf{r}\right)
$$<p>It indicates that the linear acceleration of the point of $\mathbf{y}$ comprises two parts: the linear acceleration of point $\mathbf{x}$; and the angular velocity of $\mathbf{x}$, which is proportional to the length $\mathbf{r}$.</p><p>In summary, Eq. (3) and Eq. (4) give the linear acceleration and angular velocity relationships between the two points in the rigid body system.</p><p>In the following, we assume the IMU measurements are aligned with ego-car coordinates.</p><h2 id=model-dynamics>Model Dynamics<a hidden class=anchor aria-hidden=true href=#model-dynamics>#</a></h2><h3 id=nominal-dynamic-model>Nominal Dynamic Model<a hidden class=anchor aria-hidden=true href=#nominal-dynamic-model>#</a></h3><p>The ego-car kinematic model is</p>$$
\begin{aligned}
\dot{\mathbf{p}} &= \, \mathbf{v}\\
\dot{\mathbf{v}} &= \mathbf{R}\mathbf{a}, \\
\dot{\mathbf{a}} &= \mathbf{0}\\
\dot{\mathbf{R}} &=  \mathbf{R} \left\lfloor \boldsymbol{\omega} \right\rfloor_\times\\
\dot{\boldsymbol{\omega}} &= \mathbf{0},\\
\dot{\mathbf{b}_a}&=\mathbf{0},\\
\dot{\mathbf{b}}_w &= \mathbf{0}.
\end{aligned}
$$<p>where the state is defined as $\mathbf{x}=[\mathbf{R}^\top,\boldsymbol{\omega}^\top, \mathbf{p}^\top, \mathbf{v}^\top, \mathbf{a}^\top, \mathbf{b}_a^\top, \mathbf{b}_w^\top]^\top$, and $\mathbf{x}\in SO(3)\times\mathbb{R}^{18}$. We should note that $\mathbf{p}$, $\mathbf{v}$, $\mathbf{R}$ is defined on the global coordinate, while $\mathbf{a}$, $\boldsymbol{\omega}$, $\mathbf{b}_a$, $\mathbf{b}_w$ is defined in the body (local) coordinate.</p><h3 id=bicycle-model>Bicycle Model<a hidden class=anchor aria-hidden=true href=#bicycle-model>#</a></h3><p>Another popular kinematic model is the bicycle model. If more advanced kinematic model is needed, please refere to [10].</p><h2 id=observation-model>Observation Model<a hidden class=anchor aria-hidden=true href=#observation-model>#</a></h2><p>Let $\mathbf{y} = [\mathbf{y}_p^\top, \mathbf{y}_v^\top, \mathbf{y}_a^\top, \mathbf{y}_{\omega}^\top]^\top$, where $\mathbf{y}_p, \mathbf{y}_v, \mathbf{y}_a, \mathbf{y}_{\omega}$ denote the observed position, linear velocity, linear acceleration, and angular velocity, respectively.</p><h3 id=wheel-encoder-observation>Wheel Encoder Observation<a hidden class=anchor aria-hidden=true href=#wheel-encoder-observation>#</a></h3><div style="text-align:center;margin:0 auto;display:flex;justify-content:center"><img src=./resources/wheel-encoder.png alt="wheel encoder" style=width:50%></div><p>Assume the left and right wheel speeds are $v_1$, $v_2$, respectively. Denote $L$ as the wheel base. So, the vehicle speed, $v$, and rotation velocity, $\omega$, are</p><p>$v = \frac{v_1+v_2}{2}$, and $\omega = 2\frac{v_2 - v_1}{L}$</p><p>on the moving plane. Assume the moving plane normal is $\mathbf{n}_p$, and the moving direction is $\mathbf{d}_p$. Then the measured velocity is $\mathbf{y}_v = v\mathbf{d}_p$ and the angular velocity is $\mathbf{y}_w = w\mathbf{n}_p$. Usually, the moving direction and plane normal are aligned with one of the ego&rsquo;s coordinate axes.</p><h3 id=velocity-measurements>Velocity Measurements<a hidden class=anchor aria-hidden=true href=#velocity-measurements>#</a></h3><p>When measured by wheel encoder, the measurements is on the body coordinate. If the velocity is from the GPS or RTK, the velocity is on the global coordinate.</p><h3 id=the-gravity>The Gravity<a hidden class=anchor aria-hidden=true href=#the-gravity>#</a></h3><p>The gravity can be estimated according to the <a href=https://www.sensorsone.com/locaofl-gravity-calculator/>[online calculator]</a></p>$$
IGF = 9.780327 \left(1 + 0.0053024\sin^2(2\Phi) - 0.0000058\sin^2(2\Phi)\right)
$$$$FAC = -3.086 \times 10^{-6} \times h$$$$g = IGF + FAC$$<p>Then, in our model, we do not need to estimate gravity. Instead, we use this approximation.</p><p>Further, the direction of gravity, $\mathbf{e}_g$, can also be estimated according to the GPS signal.</p><h3 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h3><p>We have the continuous observation model:</p>$$
\mathbf{y}_p = \mathbf{p} + \boldsymbol{\varepsilon}_p,
$$$$
\mathbf{y}_v = \mathbf{R}\mathbf{v} + \boldsymbol{\varepsilon}_v,
$$<p>or</p>$$
\mathbf{y}_v = \mathbf{v} + \boldsymbol{\varepsilon}_v
$$$$
\mathbf{y}_a =\left(\mathbf{a}+\mathbf{b}_a\right) + \mathbf{g} + \boldsymbol{\varepsilon}_a
$$$$
\mathbf{y}_\omega = \boldsymbol{\omega} + \mathbf{b}_w+ \boldsymbol{\varepsilon}_w
$$<p>where $\mathbf{g} = g\mathbf{e}_g$ is gravity vector, and $\mathbf{e}_g$ is the gravity direction in the world coordinate and can be approximated according to GPS. If we move around a small local area, it can be further simplified as constant downwards to the earth center.</p><h1 id=discretize-the-model>Discretize the Model<a hidden class=anchor aria-hidden=true href=#discretize-the-model>#</a></h1><p>We follow a continuous-discrete extended Kalman filter, where we do the two steps</p><ol><li><p>Continuous-Time Prediction: Between measurements, the state estimate and error covariance are propagated continuously using differential equations</p></li><li><p>Discrete-Time Update: When a measurement becomes available, the filter performs a discrete update step to incorporate the new information</p></li></ol><h2 id=continuous-motion-model-1>Continuous Motion Model<a hidden class=anchor aria-hidden=true href=#continuous-motion-model-1>#</a></h2><p>Since using continuous/discrete EKF, we do not need to discretize the motion model explicitly. However, linearization is necessary to propagate the process noise.</p><p>Please refer to the appendix for the details of solving the ordinal differential equation and linearization. $T$ denotes the time interval between $t_{k+1}$ and $t_k$.</p>$$
\begin{aligned}
\mathbf{R}_{k+1} &= \mathbf{R}_k\boxplus  (T\boldsymbol{\omega}_k + \frac{1}{2}T^2\boldsymbol{\varepsilon}_w)\\
\boldsymbol{\omega}_{k+1} &= \boldsymbol{\omega}_k + T\boldsymbol{\varepsilon}_w\\
\mathbf{p}_{k+1} &= \mathbf{p}_k + \mathbf{v}_kT + \frac{1}{2}\mathbf{R}\mathbf{a}_kT^2+\frac{1}{6}T^3\mathbf{R}\boldsymbol{\varepsilon}_a,\\
\mathbf{v}_{k+1} &= \mathbf{v}_k +\mathbf{R}\mathbf{a}_kT + \frac{1}{2}T^2\mathbf{R}\boldsymbol{\varepsilon}_a,\\
\mathbf{a}_{k+1} &= \mathbf{a}_k + T\boldsymbol{\varepsilon}_a,\\
\mathbf{b}^w_{k+1} &= \mathbf{b}^w_k + T\boldsymbol{\epsilon}_{b_w},\\
\mathbf{b}_{k+1}^a &= \mathbf{b}_k^a + T\boldsymbol{\epsilon}_{b_a}
\end{aligned}
$$<p>and we denote it as</p>$$
\mathbf{x}_{k+1} = f(\mathbf{x}_k, \boldsymbol{\varepsilon}_k)
$$<h3 id=linearize-the-motion-model>Linearize the Motion Model<a hidden class=anchor aria-hidden=true href=#linearize-the-motion-model>#</a></h3><p>The linear motion part is already a linear function. We only need to consider the rotation part.</p><p>Let us define $\mathbf{F}_x = \mathbf{J}^f_{\mathbf{x}}$ and $\mathbf{F}_\varepsilon = \mathbf{J}^f_{\boldsymbol{\varepsilon}}$, where $\mathbf{J}^f_\mathbf{x}$ and $\mathbf{J}^f_{\boldsymbol{\varepsilon}}$ indicates the Jacobian of $f$ with respect to $\mathbf{x}$ and $\boldsymbol{\varepsilon}$, respectively.</p><p>According to [1], for $\mathbf{R}\in SO(3)$, $\mathbf{J}^{\mathbf{R}\boxplus\boldsymbol{\theta}}_{\mathbf{R}} = \mathbf{R}(\boldsymbol{\theta})^\top$ and $\mathbf{J}^{\mathbf{R}\boxplus\boldsymbol{\theta}}_{\boldsymbol{\theta}} = \mathbf{J}_r(\boldsymbol{\theta})$, $\mathbf{R}(\boldsymbol{\theta}) = \text{Exp}(\theta \mathbf{u}) \triangleq \mathbf{I} + \sin\theta[\mathbf{u}]_\times + (1-\cos\theta)[\mathbf{u}]_\times^2$, $\mathbf{J}_r(\boldsymbol{\theta}) \triangleq \mathbf{I} - \frac{1 - \cos \theta}{\theta^2} [\boldsymbol{\theta}]_{\times} + \frac{\theta - \sin \theta}{\theta^3} [\boldsymbol{\theta}]_{\times}^2$.</p>$$
\mathbf{F}_x =
\begin{bmatrix}
\mathbf{R}(T\boldsymbol{\omega}+\frac{1}{2}T^2\boldsymbol{\varepsilon}_w)^\top & T\mathbf{J}_r(T\boldsymbol{\omega}+\frac{1}{2}T^2\boldsymbol{\varepsilon}_w) & \mathbf{0}&\mathbf{0} &\mathbf{0}&\mathbf{0}&\mathbf{0}\\
\mathbf{0}&\mathbf{I}&\mathbf{0}&\mathbf{0}&\mathbf{0} &\mathbf{0} &\mathbf{0}\\
\mathbf{0}&\mathbf{0}&\mathbf{I}&T\mathbf{I}&\frac{1}{2}T^2\mathbf{I}&\mathbf{0}&\mathbf{0}\\
\mathbf{0}&\mathbf{0}&\mathbf{0}&\mathbf{I}&T\mathbf{I}&\mathbf{0}&\mathbf{0}\\
\mathbf{0}&\mathbf{0}&\mathbf{0}&\mathbf{0}&\mathbf{I}&\mathbf{0}&\mathbf{0}\\
\mathbf{0}&\mathbf{0} &\mathbf{0} &\mathbf{0} &\mathbf{0} &T\mathbf{I} &\mathbf{0}\\
\mathbf{0}&\mathbf{0}&\mathbf{0}&\mathbf{0}&\mathbf{0}&\mathbf{0}&T\mathbf{I}
\end{bmatrix},
$$<p>And</p>$$
\mathbf{F}_\varepsilon =
\begin{bmatrix}
 \frac{1}{2}T^2\mathbf{J}_r(T\boldsymbol{\omega}+\frac{1}{2}T^2\boldsymbol{\varepsilon}_w)&\mathbf{0}&\mathbf{0}\\
T\mathbf{I}&\mathbf{0}&\mathbf{0}\\
\mathbf{0}&\frac{1}{6}T^3\mathbf{I}&\mathbf{0}\\
\mathbf{0}&\frac{1}{2}T^2\mathbf{I}&\mathbf{0}\\
\mathbf{0}&T\mathbf{I}&\mathbf{0}\\
\mathbf{0}&\mathbf{0}&T\mathbf{I}\\
\mathbf{0}&\mathbf{0}&T\mathbf{I}
\end{bmatrix}
$$<p>Then, the discrete motion model can be linearly approximated as</p>$$
\begin{equation*}
\mathbf{x}_{k+1} \approx f(\hat{\mathbf{x}}_k, \mathbf{0})+ \mathbf{F}_{x}|_{\mathbf{\mathbf{x}}=\hat{\mathbf{x}}_k, \boldsymbol{\varepsilon=\mathbf{0}}}\cdot(\mathbf{x}_k-\hat{\mathbf{x}}_{k})+\mathbf{F}_{\varepsilon}|_{\mathbf{\mathbf{x}}=\hat{\mathbf{x}}_k, \boldsymbol{\varepsilon=\mathbf{0}}}\cdot\boldsymbol{\varepsilon}_k
\end{equation*}
$$<h2 id=discretize-the-observation-model>Discretize the Observation Model<a hidden class=anchor aria-hidden=true href=#discretize-the-observation-model>#</a></h2>$$
\begin{aligned}
\mathbf{y}_\omega^k &=\boldsymbol{\omega}^k +\mathbf{b}_w^k + \boldsymbol{\varepsilon}_w^k,\\
\mathbf{y}_p^k &= \mathbf{p}^k + \boldsymbol{\varepsilon}_p^k\\
\mathbf{y}_v^k &= \mathbf{R}^k\mathbf{v}^k + \boldsymbol{\varepsilon}_v^k, \text{ or }
\mathbf{y}_v^k &= \mathbf{v}^k + \boldsymbol{\varepsilon}_v^k\\
\mathbf{y}_a^k &=\mathbf{a}^k+\mathbf{b}_a^k +  \mathbf{g} + \boldsymbol{\varepsilon}_a^k
\end{aligned}
$$<p>And compactly denote it as</p>$$
\mathbf{y}_k=h(\mathbf{x}_k,\boldsymbol{\varepsilon}_k).
$$<h3 id=linearize-the-observation-model>Linearize the Observation Model<a hidden class=anchor aria-hidden=true href=#linearize-the-observation-model>#</a></h3><p>Also, let $\mathbf{H}_x = \mathbf{J}^h_x$ and $\mathbf{H}_\varepsilon = \mathbf{J}^h_\varepsilon$ represent the Jacobian of $h$ with respect to $\mathbf{x}$ and $\boldsymbol{\epsilon}$, respectively. We have</p>$$
\mathbf{H}_x = 
\begin{bmatrix}
\mathbf{0}&\mathbf{I}&\mathbf{0}&\mathbf{0}&\mathbf{0} &\mathbf{I} &\mathbf{0}\\
\mathbf{0}&\mathbf{0}&\mathbf{I}&\mathbf{0}&\mathbf{0}&\mathbf{0}&\mathbf{0}\\
-\mathbf{R}[\mathbf{v}]_\times&\mathbf{0}&\mathbf{0}&\mathbf{I}&\mathbf{0}&\mathbf{0}&\mathbf{0}\\
-\mathbf{R}[\mathbf{a}+\mathbf{b}_a]_\times&\mathbf{0}&\mathbf{0}&\mathbf{0}&\mathbf{I} &\mathbf{0} &\mathbf{I}
\end{bmatrix},
$$<p>where we use the identity $\mathbf{J}^{\mathbf{R}\boldsymbol{\theta}}_{\mathbf{R}} = -\mathbf{R}[\boldsymbol{\theta}]_\times$,</p>$$
[\boldsymbol{\theta}]_\times=
\begin{bmatrix}
0&-\theta_z&\theta_y\\
\theta_z&0&-\theta_x\\
-\theta_y&\theta_x&0
\end{bmatrix}
$$<p>and</p>$$
\mathbf{H}_\varepsilon = 
\begin{bmatrix}
\mathbf{I}\\
\mathbf{I}\\
\mathbf{I}\\
\mathbf{I}
\end{bmatrix}
$$<p>Thus, the observation model can be linearized as</p>$$
\begin{equation*}
\mathbf{y}_k \approx h(\mathbf{x}_{k|k-1}, \mathbf{0}) +
\mathbf{H}_x|_{\mathbf{x}=\mathbf{x}_{k|k-1},\boldsymbol{\varepsilon}=\mathbf{0}}\cdot(\mathbf{x}_k-\mathbf{x}_{k|k-1}) + \mathbf{H}_\varepsilon|_{\mathbf{x}=\mathbf{x}_{k|k-1},\boldsymbol{\varepsilon}=\mathbf{0}}\cdot\boldsymbol{\varepsilon}_k
\end{equation*}
$$<h1 id=iterative-extended-kalman-filter>Iterative Extended Kalman Filter<a hidden class=anchor aria-hidden=true href=#iterative-extended-kalman-filter>#</a></h1><p>This section shows how the iterative extended Kalman filter&rsquo;s update steps</p><h2 id=predict-step>Predict Step<a hidden class=anchor aria-hidden=true href=#predict-step>#</a></h2><p>Given last time estimation $\mathbf{x}_{k-1} \sim \mathcal{N}(\hat{\mathbf{x}}_{k-1}, \hat{\mathbf{P}}_{k-1})$</p><p>Update state: $\mathbf{x}_{k|k-1} = f(\hat{\mathbf{x}}_{k-1}, \mathbf{0})$</p><p>Update covariance: $\mathbf{P}_{k|k-1} = \mathbf{F}_x\hat{\mathbf{P}}_{k-1}\mathbf{F}_x^\top+\mathbf{F}_{\varepsilon}\mathbf{Q}_{\varepsilon}\mathbf{F}_{\varepsilon}^\top$</p><p>where $\mathbf{Q}_{\varepsilon}$ is the process noise covariance.</p><h2 id=correct-step>Correct Step<a hidden class=anchor aria-hidden=true href=#correct-step>#</a></h2><p>Iterate</p><p>Update gain: $\mathbf{K}_k = \mathbf{P}_{k|k-1}\mathbf{H}_x^\top\left(\mathbf{H}_x\mathbf{P}_{k|k-1}\mathbf{H}_x^\top+\mathbf{H}_\varepsilon\mathbf{R}_k\mathbf{H}_\varepsilon^\top\right)^{-1}$</p><p>Update mean: $\hat{\mathbf{x}}_k = \mathbf{x}_{k|k-1} \boxplus \mathbf{K}_k\left(\mathbf{y}_k\boxminus h(\mathbf{x}_{k|k-1},\mathbf{0})\right)$</p><p>Update covariance: $\hat{\mathbf{P}}_{k} = \left(\mathbf{I}-\mathbf{K}_k\mathbf{H}_x\right)\mathbf{P}_{k|k-1}$</p><p>If converged: break; else: substitute the new updates into (2) , get the new $\mathbf{H}_x$ and $\mathbf{H}_\varepsilon$, and repeat the correcting step.</p><h2 id=note>Note<a hidden class=anchor aria-hidden=true href=#note>#</a></h2><ol><li><p>We may only have parts of the observations. So, revise the $\mathbf{H}_x$ accordingly.</p></li><li><p><del>When updating the $\mathbf{p}$ and $\boldsymbol{\omega}$individually or combine, we do not need to iterate the correcting step. Since it is already a linear observation.</del></p></li><li><p>Compared with the traditional iterative extended Kalman filter, the only difference lies in the the mean updating step, where we substitute $\boxplus$ with $+$. Since $\mathbf{y}_k\in \mathbb{R}^{12}$, so $\boxminus$ can be replaced by $-$.</p></li></ol><h1 id=implementations>Implementations<a hidden class=anchor aria-hidden=true href=#implementations>#</a></h1><p>There are three ways to describe a rotation: axis-angle, matrix, and quaternion. In this section, we will explore their relationships and its numerical stability when implementation. [8]</p><h2 id=axis-angle-to-matrix>Axis-angle to matrix<a hidden class=anchor aria-hidden=true href=#axis-angle-to-matrix>#</a></h2><p>The Exponential map</p>$$\begin{aligned}
\text{Exp} : \mathbb{R}^3
& \longrightarrow \text{SO}(3) \\
\boldsymbol{\omega}
& \longmapsto \mathbb{R}_{3 \times 3}
\end{aligned}$$<p>Rodrigues&rsquo; formula</p>$$\text{Exp}(\boldsymbol{\omega})
\triangleq
\mathbf{R}(\mathbf{n},\theta) =\mathbf{I} + \sin\theta[\mathbf{n}]_\times + (1-\cos\theta)[\mathbf{n}]_\times^2,$$<p>where $\boldsymbol{\omega} = \theta\mathbf{n}$, and $\theta= \|\boldsymbol{\omega}\|$.</p>$$
\mathbf{R}(\mathbf{n}, \theta) = \begin{pmatrix}
\cos \theta + n_1^2 (1 - \cos \theta) & n_1 n_2 (1 - \cos \theta) - n_3 \sin \theta & n_1 n_3 (1 - \cos \theta) + n_2 \sin \theta \\
n_1 n_2 (1 - \cos \theta) + n_3 \sin \theta & \cos \theta + n_2^2 (1 - \cos \theta) & n_2 n_3 (1 - \cos \theta) - n_1 \sin \theta \\
n_1 n_3 (1 - \cos \theta) - n_2 \sin \theta & n_2 n_3 (1 - \cos \theta) + n_1 \sin \theta & \cos \theta + n_3^2 (1 - \cos \theta)
\end{pmatrix}.
$$<h2 id=axis-angle-to-quaternion>Axis-angle to Quaternion<a hidden class=anchor aria-hidden=true href=#axis-angle-to-quaternion>#</a></h2><p>The exponential map can also be directly mapped as a unit quaternion $[q_r, \, q_x, \, q_y, \, q_z]^\top$:</p>$$
e^{\omega}_q =
\begin{cases}
(1, 0, 0, 0)^\top, & \text{if } \boldsymbol{\omega} = (0, 0, 0)^\top \\
\left( \cos \frac{|\boldsymbol{\omega}|}{2}, \sin \frac{|\boldsymbol{\omega}|}{2} \frac{\boldsymbol{\omega}}{|\boldsymbol{\omega}|} \right)^\top, & \text{otherwise}
\end{cases}
$$<h2 id=matrix-to-axis-angle>Matrix to Axis-angle<a hidden class=anchor aria-hidden=true href=#matrix-to-axis-angle>#</a></h2>$$\begin{equation}
\cos \theta = \frac{1}{2} (\text{tr}(\mathbf{R}) - 1)\\
\sin \theta = \left(1 - \cos^2 \theta \right)^{1/2} = \frac{1}{2} \sqrt{(3 - \text{tr}(\mathbf{R}))(1 + \text{tr}(\mathbf{R}))}
\end{equation}$$<p>where $\sin \theta \geq 0$ is a consequence of the convention for the range of the rotation angle, $\theta \in [0, \pi]$.</p><p>Then from Rodrigues&rsquo; formula and Taylor approximation it follows that logarithmic map can be implemented as follows:</p>$$\begin{aligned}
\boldsymbol{\omega} &= 
\text{Log}(\mathbf{R}) =\left[\log(\mathbf{R})\right]^\vee = \frac{\theta}{2 \sin \theta} \left[\mathbf{R} - \mathbf{R}^\top\right]^\vee \\
& = \frac{\theta}{2 \sin \theta} (R_{32} - R_{23}, R_{13} - R_{31}, R_{21} - R_{12})^\top,\\
\boldsymbol{\omega} &= 0.5 \cdot \left(1 + \frac{\theta^2}{6} + \frac{7}{360} \theta^4\right) \left[\mathbf{R} - \mathbf{R}^\top\right]^\vee, \quad \text{if } \text{abs}(3 - \text{tr}(\mathbf{R})) < 10^{-8}.
\end{aligned}$$<p>The above implementation is the most common, however, it diverges at a special case when the angle of rotation $\theta$ is close to $\pi$. Nevertheless, it is possible to describe the log map at these edge cases when $\sin\theta = 0$, that is $\theta = 0$ or $\theta = \pi$. In both cases $R_{ij} = R_{ji}$, and $\boldsymbol{\omega}$ can not be determined by the above equations. However, the angle $\theta$ is derived from eq. (3) , and inserting it into Rodrigues&rsquo; formula :</p>$$\frac{\boldsymbol{\omega}}{|\boldsymbol{\omega}|} = \mathbf{n} = \begin{cases}
\left(\epsilon_1 \sqrt{\frac{1}{2}(1 + R_{11})}, \epsilon_2 \sqrt{\frac{1}{2}(1 + R_{22})}, \epsilon_3 \sqrt{\frac{1}{2}(1 + R_{33})}\right)^\top, & \text{if } \theta = \pi \\
(0, 0, 0), & \text{if } \theta = 0
\end{cases}$$<p>where the individual signs $\epsilon_i = \pm 1$ (if $n_i \neq 0$) are determined up to an overall sign (since $\mathbf{R}(\mathbf{n}, \pi) = \mathbf{R}(\mathbf{n}, -\pi)$) via the following relation:</p>$$\epsilon_i \epsilon_j = \frac{R_{ij}}{\sqrt{(1 + R_{ii})(1 + R_{jj})}}, \quad \text{for } i \neq j, R_{ii} \neq -1, R_{jj} \neq -1$$<h2 id=matrix-to-quaternion>Matrix to Quaternion<a hidden class=anchor aria-hidden=true href=#matrix-to-quaternion>#</a></h2><p>The transformation from rotation matrix $\mathbf{R}$ to quaternion $\mathbf{q} = (q_r \, q_x \, q_y \, q_z)^\top = (q_r, \mathbf{q}_v^\top)^\top$ is well-defined for all angles due to resolving ambiguities through case differentiation.</p>$$\begin{aligned}
&\text{if } \text{tr}(\mathbf{R}) > 0 \\
&t = \sqrt{1 + \text{tr}(\mathbf{R})}, \quad q_r = 0.5 \cdot t, \quad \mathbf{q}_v = 0.5 / t \cdot (\mathbf{R} - \mathbf{R}^\top)^\vee \quad \quad \quad \\
&\text{else if } R_{11} \geq R_{22}, \; R_{11} \geq R_{33} \\
&t = \sqrt{1 + R_{11} - R_{22} - R_{33}}, \quad q_x = 0.5 \cdot t, \\
&q_r = 0.5 / t \cdot (R_{32} - R_{23}), \quad q_y = 0.5 / t \cdot (R_{21} + R_{12}), \quad q_z = 0.5 / t \cdot (R_{13} + R_{31}) \quad \\
&\text{else if } R_{22} > R_{11}, \; R_{22} \geq R_{33} \\
&t = \sqrt{1 + R_{22} - R_{33} - R_{11}}, \quad q_y = 0.5 \cdot t, \\
&q_r = 0.5 / t \cdot (R_{13} - R_{31}), \quad q_z = 0.5 / t \cdot (R_{12} + R_{21}), \quad q_x = 0.5 / t \cdot (R_{23} + R_{32}) \quad \\
&\text{else if } R_{33} > R_{11}, \; R_{33} > R_{22} \\
&t = \sqrt{1 + R_{33} - R_{11} - R_{22}}, \quad q_z = 0.5 \cdot t, \\
&q_r = 0.5 / t \cdot (R_{21} - R_{12}), \quad q_x = 0.5 / t \cdot (R_{32} + R_{23}), \quad q_y = 0.5 / t \cdot (R_{31} + R_{13}) \quad
\end{aligned}$$<h2 id=quaternion-to-axis-angle>Quaternion to Axis-angle<a hidden class=anchor aria-hidden=true href=#quaternion-to-axis-angle>#</a></h2><p>The logarithm map can be directly given from a unit quaternion $\mathbf{q} = (q_r \, q_x \, q_y \, q_z)^\top = (q_r, \mathbf{q}_v^\top)^\top$:</p>$$\begin{aligned}
&\log : \text{SO}(3) \longrightarrow \mathfrak{so}(3) \\
&\text{SU}(2) \longrightarrow \boldsymbol{\omega}
\end{aligned}$$<p>and</p>$$
\boldsymbol{\omega} = 2 \arccos(q_r) \frac{\mathbf{q}_v}{\|\mathbf{q}_v\|_2}.
$$<p>Or the numerically more stable implementation:</p>$$
\begin{aligned}
\mathbf{q} &= \text{sign}(q_r) \mathbf{q}\\
\boldsymbol{\omega} &= \left( \frac{2}{q_r} - \frac{2}{3} \cdot \frac{\|\mathbf{q}_v\|_2^2}{q_r^3} \right) \mathbf{q}_v, \quad \text{if } \|\mathbf{q}_v\|_2 < \epsilon \\
\boldsymbol{\omega} &= 4 \arctan \left( \frac{\|\mathbf{q}_v\|_2}{q_r + \sqrt{q_r^2 + \|\mathbf{q}_v\|_2^2}} \right) \cdot \frac{\mathbf{q}_v}{\|\mathbf{q}_v\|_2}, \quad \text{else}
\end{aligned}
$$<h2 id=quaternion-to-matrix>Quaternion to Matrix<a hidden class=anchor aria-hidden=true href=#quaternion-to-matrix>#</a></h2>$$\mathbf{R}(\mathbf{q}) = \begin{bmatrix} w^2 + x^2 - y^2 - z^2 & 2(xy - wz) & 2(xz + wy) \\ 2(xy + wz) & w^2 - x^2 + y^2 - z^2 & 2(yz - wx) \\ 2(xz - wy) & 2(yz + wx) & w^2 - x^2 - y^2 + z^2 \end{bmatrix}$$<h1 id=appendix>Appendix<a hidden class=anchor aria-hidden=true href=#appendix>#</a></h1><h2 id=discretize-the-model-1>Discretize the Model<a hidden class=anchor aria-hidden=true href=#discretize-the-model-1>#</a></h2><h3 id=solving-the-general-form-of-the-differential-equation>Solving the General Form of the Differential Equation<a hidden class=anchor aria-hidden=true href=#solving-the-general-form-of-the-differential-equation>#</a></h3><p>&ldquo;Differential Equations and Linear Algebra&rdquo;, Theorem 11.45 (first order) [6]</p>$$\mathbf{x}^\prime(t) = \mathbf{A} \mathbf{x}(t) + \mathbf{f}(t), \quad \mathbf{x}(t_0) = \mathbf{x}_0$$<p>The solution to this system is</p>$$
\mathbf{x}(t) = e^{\mathbf{A}t}\mathbf{x}(t_0) + e^{\mathbf{A}t}\int_{t_0}^{t} e^{-s\mathbf{A}}\mathbf{f}(s)ds \tag{5}
$$<p>where $e^{\mathbf{A}t}=\sum_{k=0}^{\infty}\mathbf{A}^k\frac{t^k}{k!}$.</p><h3 id=discretization-of-linear-state-space-model>Discretization of Linear State-Space Model<a hidden class=anchor aria-hidden=true href=#discretization-of-linear-state-space-model>#</a></h3><p>Refer to the wiki page <a href=https://en.wikipedia.org/wiki/Discretization>Discretization</a> and &ldquo;Introduction to Random Signals and Applied Kalman filtering&rdquo;, Chapter 5.3 [11] for more details.</p>$$\dot{x}(t) = Ax(t) + Bu(t)$$<p>Substitute $t_0=kT$, $\mathbf{x}[k] = \mathbf{x}(t_0)$ and $\mathbf{x}[k+1] = \mathbf{x}((k+1)T)$ into Eq. (5), we have</p>$$\begin{aligned}
x[k+1]
&= e^{AT} x[k] + \left( \int_0^T e^{Av} \, dv \right) Bu[k] \\
&= \left( \sum_{k=0}^{\infty} \frac{1}{k!} (AT)^k \right) x[k] + \left( \sum_{k=1}^{\infty} \frac{1}{k!} A^{k-1}T^k \right) Bu[k]
\end{aligned} \tag{6}$$<p>Please refer to the wiki page <a href=https://en.wikipedia.org/wiki/Matrix_exponential>Matrix exponential</a> for how to compute or approximate matrix exponential.</p><p>Alternative discretization approaches such as the forward Euler method, backward Euler method, and bilinear transform are also viable options depending on accuracy requirements and computational constraints.</p><h3 id=example>Example<a hidden class=anchor aria-hidden=true href=#example>#</a></h3><p>Constant acceleration model, the hidden state is $\mathbf{z} = [x, \dot{x}, \ddot{x}]$ and the state dynamic is $\ddot{x} =0$, rewrite the state dynamic in first order differential equation as below</p>$$\begin{aligned}
\begin{bmatrix}
x\\
\dot{x}\\
\ddot{x}
\end{bmatrix}
&=
\begin{bmatrix}
0 & 1 & 0\\
0 & 0 & 1\\
0 & 0 & 0
\end{bmatrix}
\begin{bmatrix}
x\\
\dot{x}\\
\ddot{x}
\end{bmatrix} +
\begin{bmatrix}
0 \\
0\\
a
\end{bmatrix}
\\
&=
\mathbf{A}\mathbf{z} + \mathbf{u}
\end{aligned}$$<p>where $a$ is the noise on the acceleration.</p><p>According to Eq. (6), and note that $\mathbf{A}^k = \mathbf{0}$ when $k > 2$, so we have</p>$$\begin{aligned}
\mathbf{z}_{k+1}
&= \left(\mathbf{I}+\mathbf{A}T + \frac{1}{2}\mathbf{A}^2T^2\right) \mathbf{z}_k + \left(\mathbf{I}T + \frac{1}{2}T^2\mathbf{A} + \frac{1}{6}\mathbf{A}^2T^3\right)\mathbf{u} \\
&= 
\begin{bmatrix}
1 & T & \frac{1}{2}T^2 \\
0 & 1 & T \\
0 & 0 & 1
\end{bmatrix}
\mathbf{z}_k +
T
\begin{bmatrix}
1 & \frac{T}{2} & \frac{T^2}{6} \\
0 & 1 &  \frac{T}{2} \\
0 & 0 & 1
\end{bmatrix}
\mathbf{u}\\
&= 
\begin{bmatrix}
x_k + \dot{x}_kT + \frac{1}{2}\ddot{x}_kT^2 \\
\dot{x}_k + \ddot{x}_kT \\
\ddot{x}_k
\end{bmatrix} +
\begin{bmatrix}
\frac{T^2}{6} \\
\frac{T}{2} \\
1
\end{bmatrix}
aT
\end{aligned}$$<h1 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h1><p>[1] J. Solà, J. Deray, and D. Atchuthan, &ldquo;A micro Lie theory for state estimation in robotics.&rdquo; arXiv, Dec. 08, 2021. doi: 10.48550/arXiv.1812.01537.</p><p>[2] W. Xu and F. Zhang, &ldquo;FAST-LIO: A Fast, Robust LiDAR-inertial Odometry Package by Tightly-Coupled Iterated Kalman Filter.&rdquo; arXiv, Apr. 14, 2021. Accessed: May 06, 2024. [Online]. Available: <a href=http://arxiv.org/abs/2010.08196>http://arxiv.org/abs/2010.08196</a></p><p>[3] F. Bullo and R. M. Murray, &ldquo;Proportional derivative (pd) control on the euclidean group,&rdquo; in European control conference, vol. 2, 1995, pp. 1091–1097.</p><p>[4] A. T. Erdem and A. O. Ercan, &ldquo;Fusing Inertial Sensor Data in an Extended Kalman Filter for 3D Camera Tracking,&rdquo; IEEE Trans. on Image Process., vol. 24, no. 2, pp. 538–548, Feb. 2015, doi: 10.1109/TIP.2014.2380176.</p><p>[5] F. Shah, &ldquo;Diﬀerential Equations Cheatsheet&rdquo;.</p><p>[6] G. Strang, Differential Equations and Linear Algebra. Wellesley, MA: Wellesley-Cambridge Press, 2014.</p><p>[7] <a href=https://homes.cs.washington.edu/~todorov/courses/cseP590/readings/tutorialEKF.pdf>Extended Kalman Filter Tutorial</a></p><p>[8] Z. Nurlanov, &ldquo;Exploring SO(3) logarithmic map: degeneracies and derivatives&rdquo;.</p><p>[9] <a href=https://www.cs.cmu.edu/~./motionplanning/papers/sbp_papers/kalman/ekf_lecture_notes.pdf>Extended Kalman Filter Lecture Notes</a></p><p>[10] J. Kong, M. Pfeiffer, G. Schildbach, and F. Borrelli, &ldquo;Kinematic and dynamic vehicle models for autonomous driving control design,&rdquo; in 2015 IEEE Intelligent Vehicles Symposium (IV), Jun. 2015, pp. 1094–1099. doi: 10.1109/IVS.2015.7225830.</p><p>[11] R. G. Brown and P. Y. C. Hwang, Introduction to Random Signals and Applied Kalman Filtering with MATLAB Exercises, 4th ed. Hoboken, NJ: Wiley, 2012.</p><p>[12] Wikipedia contributors, &ldquo;Discretization,&rdquo; Wikipedia, The Free Encyclopedia, Jan. 2024. [Online]. Available: <a href=https://en.wikipedia.org/wiki/Discretization>https://en.wikipedia.org/wiki/Discretization</a>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://livey.github.io/tags/autonomous-driving/>Autonomous-Driving</a></li><li><a href=https://livey.github.io/tags/signal-processing/>Signal Processing</a></li><li><a href=https://livey.github.io/tags/pose-tracking/>Pose Tracking</a></li><li><a href=https://livey.github.io/tags/kalman-filter/>Kalman Filter</a></li></ul><nav class=paginav><a class=prev href=https://livey.github.io/posts/2024-12-radar-processing/><span class=title>« Prev</span><br><span>Radar Signal Processing: A Tutorial</span>
</a><a class=next href=https://livey.github.io/posts/2024-12-positioning-track/><span class=title>Next »</span><br><span>Position Filtering with Ego Motion Compensation</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Pose Tracking with Iterative Extended Kalman Filter on x" href="https://x.com/intent/tweet/?text=Pose%20Tracking%20with%20Iterative%20Extended%20Kalman%20Filter&amp;url=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-pose-tracking%2f&amp;hashtags=AutonomousDriving%2cSignalProcessing%2cPoseTracking%2cKalmanFilter"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Pose Tracking with Iterative Extended Kalman Filter on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-pose-tracking%2f&amp;title=Pose%20Tracking%20with%20Iterative%20Extended%20Kalman%20Filter&amp;summary=Pose%20Tracking%20with%20Iterative%20Extended%20Kalman%20Filter&amp;source=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-pose-tracking%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Pose Tracking with Iterative Extended Kalman Filter on reddit" href="https://reddit.com/submit?url=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-pose-tracking%2f&title=Pose%20Tracking%20with%20Iterative%20Extended%20Kalman%20Filter"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Pose Tracking with Iterative Extended Kalman Filter on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-pose-tracking%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Pose Tracking with Iterative Extended Kalman Filter on whatsapp" href="https://api.whatsapp.com/send?text=Pose%20Tracking%20with%20Iterative%20Extended%20Kalman%20Filter%20-%20https%3a%2f%2flivey.github.io%2fposts%2f2024-12-pose-tracking%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Pose Tracking with Iterative Extended Kalman Filter on telegram" href="https://telegram.me/share/url?text=Pose%20Tracking%20with%20Iterative%20Extended%20Kalman%20Filter&amp;url=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-pose-tracking%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Pose Tracking with Iterative Extended Kalman Filter on ycombinator" href="https://news.ycombinator.com/submitlink?t=Pose%20Tracking%20with%20Iterative%20Extended%20Kalman%20Filter&u=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-pose-tracking%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://livey.github.io/>Fuwei's Tech Notes</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>
<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Position Filtering with Ego Motion Compensation | Fuwei's Tech Notes</title>
<meta name=keywords content="Autonomous Driving,Signal Processing,Kalman Filter,Position Tracking"><meta name=description content="Object's Position Tracking with Ego Motion Compensation"><meta name=author content="Fuwei Li"><link rel=canonical href=https://livey.github.io><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://livey.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://livey.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://livey.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://livey.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://livey.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://livey.github.io/posts/2024-12-positioning-track/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><meta name=author content="Fuwei Li"><meta name=description content="Object's Position Tracking with Ego Motion Compensation"><meta property="og:type" content="article"><meta property="og:url" content="https://livey.github.io/posts/2024-12-positioning-track/"><meta property="og:title" content="Position Filtering with Ego Motion Compensation"><meta property="og:description" content="Object's Position Tracking with Ego Motion Compensation"><meta property="og:image" content="https://livey.github.io/images/site-preview.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Position Filtering with Ego Motion Compensation"><meta name=twitter:description content="Object's Position Tracking with Ego Motion Compensation"><meta name=twitter:image content="https://livey.github.io/images/site-preview.jpg"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><meta property="og:url" content="https://livey.github.io/posts/2024-12-positioning-track/"><meta property="og:site_name" content="Fuwei's Tech Notes"><meta property="og:title" content="Position Filtering with Ego Motion Compensation"><meta property="og:description" content="Object's Position Tracking with Ego Motion Compensation"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-02T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-02T00:00:00+00:00"><meta property="article:tag" content="Autonomous Driving"><meta property="article:tag" content="Signal Processing"><meta property="article:tag" content="Kalman Filter"><meta property="article:tag" content="Position Tracking"><meta property="og:image" content="https://livey.github.io/posts/2024-12-positioning-track/%3Cimage%20path/url%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://livey.github.io/posts/2024-12-positioning-track/%3Cimage%20path/url%3E"><meta name=twitter:title content="Position Filtering with Ego Motion Compensation"><meta name=twitter:description content="Object's Position Tracking with Ego Motion Compensation"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://livey.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Position Filtering with Ego Motion Compensation","item":"https://livey.github.io/posts/2024-12-positioning-track/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Position Filtering with Ego Motion Compensation","name":"Position Filtering with Ego Motion Compensation","description":"Object's Position Tracking with Ego Motion Compensation","keywords":["Autonomous Driving","Signal Processing","Kalman Filter","Position Tracking"],"articleBody":"When tracking an object’s position, we always from the ego’s perspective. However, ego’s motion makes the tracking of the object a little difficult. The basic idea is doing the tracking on the world coordinate, then transforming into the ego-car’s coordinate. In this post, we will discuss how to combine the ego’s motion into the object’s tracking concisely.\nContinuous Form Coordinate Definitions The target’s movement in the world coordinate: $o(t)$; ego-car movement in the world coordinate: $g(t)$; ego-car’s heading angle: $\\theta(t)$; observed target’s coordinate: $f(t)$.\nContinuous Motion in the World Coordinate $$\\mathbf{E}(t)\\mathbf{x}(t) = \\boldsymbol{o}(t)- \\mathbf{g}(t) \\tag{1} $$where\n$$ \\mathbf{E}(t) = \\begin{bmatrix} \\cos \\theta(t) \u0026 -\\sin\\theta(t) \\\\ \\sin \\theta(t) \u0026 \\cos\\theta(t) \\end{bmatrix} $$is the basis and it also represents the rotation of the ego car, $\\mathbf{x}(t) = [x_x(t), x_y(t)]^\\top$ is the observed relative position at time $t$ under the basis $\\mathbf{E}(t)$, $\\mathbf{o}(t)=[o_x(t), o_y(t)]^\\top$ and $\\mathbf{g}(t) = [g_x(t), g_y(t)]^\\top$ are the object’s and ego-car’s motion in the world coordinate, respectively. Taking first and second derivatives of the equation (1) with respect to time, we have\n$$ \\partial \\mathbf{E} \\mathbf{x} + \\mathbf{E} \\partial \\mathbf{x} = \\partial (\\mathbf{o} -\\mathbf{g}) \\tag{2} $$and\n$$ \\partial^2\\mathbf{E} \\mathbf{x} + 2\\partial\\mathbf{E}\\partial\\mathbf{x} + \\mathbf{E}\\partial^2\\mathbf{x} = \\partial^2(\\mathbf{o} - \\mathbf{g}) \\tag{3} $$According to equation (1), the observed relative position satisfies\n$$ \\mathbf{x}(t) = \\mathbf{E}^{-1}(t)(\\mathbf{o}(t) - \\mathbf{g}(t)) \\tag{4} $$Thus, the observed object’svelocity satisfies\n$$ \\begin{aligned} \\partial \\mathbf{x} = \\partial \\mathbf{E}^{-1} \\,(\\mathbf{o} - \\mathbf{g}) + \\mathbf{E}^{-1}\\,(\\partial \\mathbf{o} - \\partial \\mathbf{g}) \\end{aligned} \\tag{5} $$and the observed object’s acceleration satisfies\n$$ \\begin{aligned} \\partial^2 \\mathbf{x} =\u0026 \\partial^2 \\mathbf{E}^{-1}(\\mathbf{o} - \\mathbf{g}) + \\partial \\mathbf{E}^{-1}(\\partial \\mathbf{o} - \\partial\\mathbf{g}) \\\\ \u0026+ \\partial \\mathbf{E}^{-1}(\\partial \\mathbf{o} - \\partial \\mathbf{g}) + \\mathbf{E}^{-1}(\\partial^2 \\mathbf{o} - \\partial^2\\mathbf{g}) \\\\ =\u0026\\partial^2 \\mathbf{E}^{-1}(\\mathbf{o} - \\mathbf{g}) + 2\\partial \\mathbf{E}^{-1}(\\partial \\mathbf{o} - \\partial\\mathbf{g}) + \\mathbf{E}^{-1}(\\partial^2 \\mathbf{o} - \\partial^2\\mathbf{g}) \\end{aligned} \\tag{6} $$where\n$$ \\mathbf{E} = \\begin{bmatrix} \\cos\\theta \u0026 -\\sin\\theta \\\\ \\sin\\theta \u0026 \\cos\\theta \\end{bmatrix} $$$$ \\mathbf{E}^{-1} = \\begin{bmatrix} \\cos\\theta \u0026 \\sin\\theta \\\\ -\\sin\\theta \u0026 \\cos\\theta \\end{bmatrix} $$$$ \\partial\\mathbf{E} = \\partial\\theta \\begin{bmatrix} -\\sin\\theta \u0026 -\\cos\\theta \\\\ \\cos\\theta \u0026 -\\sin\\theta \\end{bmatrix} $$$$ \\partial^2\\mathbf{E} = \\partial^2\\theta \\begin{bmatrix} -\\sin\\theta \u0026 -\\cos\\theta\\\\ \\cos\\theta \u0026 -\\sin\\theta \\end{bmatrix} + (\\partial\\theta)^2 \\begin{bmatrix} -\\cos\\theta \u0026 \\sin\\theta \\\\ -\\sin\\theta \u0026 -\\cos\\theta \\end{bmatrix} $$$$\\partial\\mathbf{E}^{-1} = \\partial\\theta \\cdot \\begin{bmatrix} -\\sin\\theta \u0026 \\cos\\theta\\\\ -\\cos\\theta \u0026 -\\sin\\theta \\end{bmatrix} $$$$ \\partial^2\\mathbf{E}^{-1} = \\partial^2\\theta \\begin{bmatrix} -\\sin\\theta \u0026 \\cos\\theta \\\\ -\\cos\\theta \u0026 -\\sin\\theta \\end{bmatrix} + (\\partial \\theta)^2 \\begin{bmatrix} -\\cos\\theta \u0026 -\\sin\\theta\\\\ \\sin\\theta \u0026 -\\cos\\theta \\end{bmatrix}. $$Also,\n$$ \\begin{aligned} \\partial\\mathbf{E} \\mathbf{x} \u0026 = \\partial\\theta \\cdot \\begin{bmatrix} -\\sin\\theta \u0026 -\\cos\\theta\\\\ \\cos\\theta \u0026 -\\sin\\theta \\end{bmatrix} \\cdot \\mathbf{x} \\\\ \u0026= \\omega \\mathbf{E} \\begin{bmatrix} 0 \u0026 -1 \\\\ 1 \u0026 0 \\end{bmatrix} \\cdot \\mathbf{x} \\\\ \u0026= \\mathbf{E} [\\omega ]_\\times\\mathbf{x} \\end{aligned}, $$where $\\omega=\\partial \\theta/\\partial t$ is the angular velocity and $[\\omega]_\\times$ is the skew-symmetric matrix of $\\omega$, defined as\n$$ [\\omega]_\\times = \\begin{bmatrix} 0 \u0026 -\\omega \\\\ \\omega \u0026 0 \\end{bmatrix}. $$If we embed the plane into a 3D space, then the rotation $\\omega$ can be represented as vector, $[0, 0, \\omega]^\\top$, and a point, $[x, y]$ in 3D is $[x, y, 0]^\\top$. Then the cross product of $\\omega$ and $\\mathbf{x}$ is\n$$ \\begin{bmatrix} 0\\ 0\\ \\omega \\end{bmatrix} \\times \\begin{bmatrix} x \\ y \\ 0 \\end{bmatrix} \\omega \\begin{bmatrix} -y\\ x\\ 0 \\end{bmatrix}. $$\nIts first two elements are indeed $[\\omega]_\\times\\mathbf{x}$. It represents the tangential velocity. Then the velocity Eq. (2) can be rewritten as\n$$ \\mathbf{E}(\\mathbf{v}_r + \\mathbf{v}_t) = \\mathbf{v}_o - \\mathbf{v}_g $$where $\\mathbf{v}_r = \\partial \\mathbf{x}/ \\partial t$ is relative velocity, $\\mathbf{v}_t$ is the tangential velocity. If we want to connect the velocity between local and world, we need to subtract the tangential velocity. Further, if the ego-car’s velocity is given in its own coordinate system, i.e., $\\mathbf{E}\\mathbf{v}_e = \\mathbf{v}_g$, we have\n$$ \\mathbf{v}_o = \\mathbf{E}(\\mathbf{v}_r + \\mathbf{v}_t + \\mathbf{v}_e). \\tag{7} $$This equation gives us clear physical meaning of the velocities.\nContinuous Motion Model The motion ordinary differential equation (ODE) is\n$$\\dot{\\mathbf{o}}(t) = \\mathbf{A}\\mathbf{o}(t) + \\mathbf{n}(t)$$where if it is a constant velocity model, we have $\\mathbf{o}(t) = [s(t), \\dot{s}(t)]^\\top $,\n$$ \\mathbf{A} = \\begin{bmatrix} 0 \u0026 1\\\\ 0 \u0026 0 \\end{bmatrix} $$$\\mathbf{n}(t) = [0, n]^\\top$, and if it is a constant acceleration model we have $\\mathbf{o}(t) = [s(t), \\dot{s}(t), \\ddot{s}(t)]^\\top$,\n$$ \\mathbf{A} = \\begin{bmatrix} 0 \u0026 1 \u0026 0\\\\ 0 \u0026 0 \u0026 1\\\\ 0 \u0026 0 \u0026 0 \\end{bmatrix} $$$\\mathbf{n}(t) = [0, 0, n]^\\top$.\nDiscretized Form Please refere to the Appendix of the pose tracking post for how to discretize the continuous motion model.\nWe would like to derive a recursive formula for the relative states, $\\mathbf{x}$, where $\\mathbf{x}$ can contain the relative position, velocity, and acceleration. For the objective and ego, $\\mathbf{o}$ and $\\mathbf{g}$ can also contain the position, velocity, and acceleration. The state transition and observation functions are\n$$ \\begin{aligned} \\mathbf{B}_{k-1}\\mathbf{x}_{k-1} \u0026= \\mathbf{o}_{k-1} - \\mathbf{g}_{k-1} \u0026 (8.1)\\\\ \\mathbf{B}_{k} \\mathbf{x}_{k} \u0026= \\mathbf{o}_{k} - \\mathbf{g}_{k} \u0026 (8.2)\\\\ \\mathbf{o}_{k} \u0026= \\mathbf{F}_{k}\\circ\\mathbf{o}_{k-1} + \\mathbf{n}_k \u0026 (8.3)\\\\ \\mathbf{y}_{k} \u0026= \\mathbf{H}_{k}\\mathbf{x}_{k} + \\mathbf{w}_{k} \u0026 (8.4) \\end{aligned} $$where $\\mathbf{y}_{k}$ and $\\mathbf{w}_{k}$ are the observation and observation noise, respectively. “$\\circ$” denotes the function composition. $\\mathbf{B}$ is the rotation basis matrix as will discuss in following section.\nSubstitue equation (6.1) and (6.2) into equation (6.3), we have a recurvise relationship between relative states in the ego-car’s coordinates at time $k-1$ and $k$:\n$$ \\mathbf{B}_{k}\\mathbf{x}_{k} + \\mathbf{g}_{k}= \\mathbf{F}_k\\circ [\\mathbf{B}_{k-1}\\mathbf{x}_{k-1}+ \\mathbf{g}_{k-1}]+ \\mathbf{n}_k $$Then the predicted states in the ego-car’s coordinate at time $k$:\n$$ \\mathbf{x}_k = \\mathbf{B}_k^{-1}[\\mathbf{F}_k\\circ(\\mathbf{B}_{k-1}\\mathbf{x}_{k-1}+\\mathbf{g}_{k-1}) - \\mathbf{g}_{k} + \\mathbf{n}_k] \\tag{9} $$ Form of State Basis In the following, we will derive the general form for the basis of states, $\\mathbf{B}$.\nAccording to Eq. (1), (2) and (3), for a constant velocity model we have\n$$ \\mathbf{B} = \\begin{bmatrix} \\mathbf{E} \u0026 \\mathbf{0} \\\\ \\partial \\mathbf{E} \u0026 \\mathbf{E} \\end{bmatrix} $$and for the constant acceleration model we have\n$$ \\mathbf{B} = \\begin{bmatrix} \\mathbf{E} \u0026 \\mathbf{0} \u0026 \\mathbf{0} \\\\ \\partial \\mathbf{E} \u0026 \\mathbf{E} \u0026 \\mathbf{0} \\\\ \\partial^2 \\mathbf{E} \u0026 2\\partial\\mathbf{E} \u0026 \\mathbf{E} \\end{bmatrix} $$According to Eq. (4), (5), and (6), for constant velocity model\n$$ \\mathbf{B}^{-1} = \\begin{bmatrix} \\mathbf{E}^{-1} \u0026 \\mathbf{0} \\\\ \\partial\\mathbf{E}^{-1} \u0026 \\mathbf{E}^{-1} \\end{bmatrix} $$and for a constant acceleration model we have\n$$ \\mathbf{B}^{-1} = \\begin{bmatrix} \\mathbf{E}^{-1} \u0026 \\mathbf{0} \u0026 \\mathbf{0} \\\\ \\partial\\mathbf{E}^{-1} \u0026 \\mathbf{E}^{-1} \u0026 \\mathbf{0} \\\\ \\partial^2\\mathbf{E}^{-1} \u0026 2\\partial\\mathbf{E}^{-1} \u0026 \\mathbf{E}^{-1} \\end{bmatrix} $$Since $\\partial(\\mathbf{E}^{-1}\\mathbf{E}) = \\partial\\mathbf{E}^{-1}\\mathbf{E} + \\mathbf{E}^{-1}\\partial\\mathbf{E} = \\mathbf{0}$, we have\n$$ \\begin{aligned} \\partial\\mathbf{E} \u0026=-\\mathbf{E}\\partial\\mathbf{E}^{-1}\\mathbf{E} \\\\ \u0026=-\\partial\\theta \\begin{bmatrix} 0 \u0026 1 \\\\ -1 \u0026 0 \\end{bmatrix} \\mathbf{E}\\\\ \u0026\\triangleq \\omega \\mathbf{C}\\mathbf{E} =\\omega\\mathbf{E}\\mathbf{C} \\end{aligned} $$where\n$$\\mathbf{C} = \\begin{bmatrix} 0 \u0026 -1 \\\\ 1 \u0026 0 \\end{bmatrix} $$$\\omega = \\frac{\\partial\\theta}{\\partial{t}}$, $\\mathbf{C}^\\top=-\\mathbf{C}$, $\\mathbf{C}\\mathbf{C}^\\top=\\mathbf{I}$.\n$$ \\begin{aligned} \\partial\\mathbf{E}^{-1} \u0026=-\\mathbf{E}^{-1}\\partial\\mathbf{E} \\mathbf{E}^{-1} \\\\ \u0026=-\\partial\\theta \\begin{bmatrix} 0 \u0026 -1 \\\\ 1 \u0026 0 \\end{bmatrix} \\mathbf{E}^{-1}\\\\ \u0026\\triangleq \\omega \\mathbf{C}^{-1}\\mathbf{E}^{-1} \\\\ \u0026= \\omega\\mathbf{E}^{-1}\\mathbf{C}^{-1} \\end{aligned} $$and\n$$ \\begin{aligned} \\partial^2\\mathbf{E} \u0026= -\\mathbf{E}(2\\partial\\mathbf{E}^{-1}\\partial\\mathbf{E}+ \\partial^2\\mathbf{E}^{-1}\\mathbf{E}) \\\\ \u0026= -\\mathbf{E}(2\\omega^2\\mathbf{I} - \\omega^2\\mathbf{I}-\\dot{\\omega}\\mathbf{C}) \\\\ \u0026\\triangleq [\\dot{\\omega}\\mathbf{C}-\\omega^2\\mathbf{I}]\\mathbf{E} \\\\ \u0026= \\mathbf{E}[\\dot{\\omega}\\mathbf{C}-\\omega^2\\mathbf{I}] \\end{aligned} $$$$ \\begin{aligned} \\partial^2\\mathbf{E}^{-1} \u0026= -(2\\partial\\mathbf{E}^{-1}\\partial\\mathbf{E} + \\mathbf{E}^{-1}\\partial^2\\mathbf{E})\\mathbf{E}^{-1} \\\\ \u0026=-(2\\omega^2\\mathbf{I} -\\omega^2\\mathbf{I} - \\partial^2\\theta\\mathbf{C})\\mathbf{E}^{-1} \\\\ \u0026\\triangleq [\\dot{\\omega}\\mathbf{C}^{-1} - \\omega^2\\mathbf{I}] \\mathbf{E}^{-1} \\\\ \u0026= \\mathbf{E}^{-1} [\\dot{\\omega}\\mathbf{C}^{-1} - \\omega^2\\mathbf{I}] \\end{aligned} $$Combine these and we can simplify\n$$ \\mathbf{B} = \\text{diag}(\\mathbf{E}, \\mathbf{E}) \\cdot \\begin{bmatrix} \\mathbf{I} \u0026 \\mathbf{0} \\\\ \\omega\\mathbf{C} \u0026 \\mathbf{I} \\end{bmatrix} = \\text{diag}(\\mathbf{E}, \\mathbf{E})\\mathbf{W} $$$$ \\mathbf{B}^{-1} = \\begin{bmatrix} \\mathbf{I} \u0026 \\mathbf{0}\\\\ \\omega\\mathbf{C}^{-1} \u0026 \\mathbf{I} \\end{bmatrix} \\cdot \\text{diag}(\\mathbf{E}^{-1}, \\mathbf{E}^{-1}) =\\mathbf{W}^{-1}\\cdot\\text{diag}(\\mathbf{E}^{-1}, \\mathbf{E}^{-1}). $$For state that contains position, velocity, and acceleration, we have\n$$ \\begin{aligned} \\mathbf{B} \u0026= \\text{diag}(\\mathbf{E}, \\mathbf{E}, \\mathbf{E}) \\cdot \\begin{bmatrix} \\mathbf{I} \u0026 \\mathbf{0} \u0026 \\mathbf{0}\\\\ \\omega\\mathbf{C} \u0026 \\mathbf{I} \u0026 \\mathbf{0} \\\\ \\dot{\\omega}\\mathbf{C}-\\omega^2\\mathbf{I} \u0026 2\\omega\\mathbf{C} \u0026 \\mathbf{I} \\end{bmatrix} \\\\ \u0026= \\text{diag}(\\mathbf{E}, \\mathbf{E}, \\mathbf{E})\\mathbf{W} \\end{aligned} $$and\n$$ \\begin{aligned} \\mathbf{B}^{-1} \u0026= \\begin{bmatrix} \\mathbf{I} \u0026 \\mathbf{0} \u0026 \\mathbf{0}\\\\ \\omega\\mathbf{C}^{-1} \u0026 \\mathbf{I} \u0026\\mathbf{0}\\\\ \\dot{\\omega}\\mathbf{C}^{-1}-\\omega^2\\mathbf{I} \u0026 2\\omega\\mathbf{C}^{-1} \u0026 \\mathbf{I} \\end{bmatrix} \\cdot \\text{diag}(\\mathbf{E}^{-1}, \\mathbf{E}^{-1},\\mathbf{E}^{-1}) \\\\ \u0026= \\mathbf{W}^{-1}\\text{diag}(\\mathbf{E}^{-1}, \\mathbf{E}^{-1},\\mathbf{E}^{-1}) \\end{aligned} $$Ego-pose Information In a regular system, the information of the ego-car includes: the translation, $\\mathbf{t}_k$, from $k-1$ to $k$ and the coordinate rotation matrix $\\mathbf{R}_k$, or ego velocity, $\\mathbf{v}_k$, the angular velocity, $\\omega_k$. Represent the ego-car’s information in the world coordinate we have\n$$ \\mathbf{E}_k\\mathbf{t}_k = \\mathbf{g}_{k-1} - \\mathbf{g}_{k} ,\\quad \\mathbf{E}_k\\mathbf{v}_k ,\\quad \\mathbf{R}_k = \\mathbf{E}_k^{-1}\\mathbf{E}_{k-1} $$Ego Motion Compensation According to Eq. (9) we have;\n$$\\begin{aligned} \\mathbf{x}_{k} \u0026= \\mathbf{B}_{k}^{-1} [\\mathbf{F}_k\\circ(\\mathbf{B}_{k-1}\\mathbf{x}_{k-1} +\\mathbf{g}_{k-1}) - \\mathbf{g}_{k} + \\mathbf{n}_k] \\\\ \u0026= \\mathbf{B}^{-1}_{k} \\left( \\mathbf{F}_k\\circ(\\mathbf{B}_{k-1}\\mathbf{x}_{k-1}) + \\mathbf{F}_{k}\\circ\\mathbf{g}_{k-1} - \\mathbf{g}_{k}+ \\mathbf{n}_k \\right) \\end{aligned}$$And assume the ego motion has the same motion pattern as for the object, then we have\n$$ \\begin{aligned} \\mathbf{F}_k\\circ\\mathbf{g}_{k-1} - \\mathbf{g}_k = \\mathbf{n}_{g_k} \\end{aligned} $$where $\\mathbf{n}_{g_k}$ is the process noise for the ego-car at time $k$.\nObject Part in the Motion Model The part that involves the object in the motion model is $\\mathbf{B}_k^{-1}\\mathbf{F}_k\\circ\\mathbf{B}_{k-1}\\mathbf{x}_{k-1}$. Substitute the expression of $\\mathbf{B}_k^{-1}$ we have\n$$ \\begin{aligned} \\mathbf{B}_k^{-1}\\mathbf{F}_k\\circ(\\mathbf{B}_{k-1}\\mathbf{x}_{k-1}) \u0026\\overset{(a)}{=} \\mathbf{W}_k^{-1}\\cdot\\text{diag}(\\mathbf{E}_{k}^{-1}, \\mathbf{E}_{k}^{-1}, \\cdots) \\cdot \\mathbf{F}_k \\cdot\\text{diag}(\\mathbf{E}_{k-1}, \\mathbf{E}_{k-1}, \\cdots)\\mathbf{W}_{k-1}\\mathbf{x}_{k-1} \\\\ \u0026\\overset{(b)}{=} \\mathbf{W}_k^{-1}\\text{diag}(\\mathbf{R}_k, \\mathbf{R}_k, \\cdots)\\mathbf{F}_k\\mathbf{W}_{k-1}\\mathbf{x}_{k-1} \\\\ \u0026\\overset{(c)}{=} \\mathbf{W}_k^{-1}\\mathbf{F}_k\\text{diag}(\\mathbf{R}_k, \\mathbf{R}_k, \\cdots)\\mathbf{W}_{k-1}\\mathbf{x}_{k-1}\\\\ \u0026\\overset{(d)}{=} \\bar{\\mathbf{R}}_k\\mathbf{W}_k^{-1}\\mathbf{F}_k\\mathbf{W}_{k-1}\\mathbf{x}_{k-1}\\\\ \u0026\\triangleq\\bar{\\mathbf{R}}_k\\hat{\\mathbf{F}}_k\\mathbf{x}_{k-1} \\end{aligned} $$where $\\mathbf{R}_k = \\mathbf{E}_k^{-1}\\mathbf{E}_{k-1} = \\mathbf{E}(\\theta_{k-1} - \\theta_k)$, $\\bar{\\mathbf{R}}_k = \\text{diag}(\\mathbf{R}_k, \\cdots)$, (a) established by substitute $\\mathbf{F}_k\\circ$ by its matrix formular, $\\mathbf{F}_k\\cdot$, (b) and (c) substatiates due to the assumption that $\\bar{\\mathbf{R}}\\mathbf{F} = \\mathbf{F}\\bar{\\mathbf{R}}$, which is true for a constant velocity or constant acceleration model, (d) is true as a result of $\\bar{\\mathbf{R}}\\mathbf{W}^{-1}=\\mathbf{W}^{-1} \\bar{\\mathbf{R}}$. It indicates that the order of following motion model and rotate coordinate does not matter. We can formulate the motion model only depending on the relative rotation because we can exchange the motion and the coordinate.\nConclusion The complete Kalman filter with ego-motion compensation is as follows:\nDo prediction with pseudo motion matrix,\nSubtract the ego rotation\nFollow motion model\nAdd ego rotation\nRotate\nCompensate the ego-motion\nDo correction as in traditional Kalman filter.\nApplications Static Object Position Tracking For a static object, its position does not change. So, the motion matrix is\n$\\mathbf{F} = \\mathbf{I}$, $\\mathbf{B} = \\mathbf{E}$, and $\\mathbf{W}=\\mathbf{I}$.\nWe have $\\hat{\\mathbf{F}}_k = \\mathbf{R}_k$. So that\n$$ \\mathbf{x}_k =\\mathbf{R}_k \\mathbf{x}_{k-1} + \\mathbf{E}_k^{-1}\\mathbf{n}_{g_k} + \\mathbf{n}_k $$where $\\mathbf{n}_{g_k} = \\mathbf{g}_{k-1} - \\mathbf{g}_k=\\mathbf{E}_k\\mathbf{t}_k$. Thus, we get\n$$ \\mathbf{x}_k =\\mathbf{R}_k\\mathbf{x}_{k-1} + \\mathbf{t}_k + \\mathbf{n}_k $$It means, in this case, we need to compensate for the relative translation and rotation.\nConstant Velocity Object Position Tracking The Pseudo Motion Matrix $$ \\begin{aligned} \\hat{\\mathbf{F}}_k \u0026=\\bar{\\mathbf{W}}_k^{-1}\\mathbf{F}_k\\mathbf{W}_{k-1} \\\\ \u0026= \\mathbf{F}_k + \\begin{bmatrix} \\Delta{t}\\omega_{k-1}\\mathbf{C} \u0026 \\mathbf{0} \\\\ \\Delta{t}\\omega_k\\omega_{k-1}\\mathbf{I} + (\\omega_{k-1}-\\omega_k)\\mathbf{C} \u0026 -\\Delta{t}\\omega_k\\mathbf{C} \\end{bmatrix} \\\\ \u0026\\overset{(a)}{=}\\mathbf{F}_k + \\Delta{\\theta} \\begin{bmatrix} \\mathbf{I} \u0026 \\mathbf{0} \\\\ -\\omega_k\\mathbf{C} \u0026 -\\mathbf{I} \\end{bmatrix} \\begin{bmatrix} \\mathbf{C} \u0026 \\mathbf{0} \\\\ \\mathbf{0} \u0026 \\mathbf{C} \\end{bmatrix} \\end{aligned} $$where (a) is true with assumption $\\omega_k = \\omega_{k-1}$. The second term which involves the rotated angle is usually ignored by others.\nThe complete form of $\\hat{\\mathbf{F}}_k$ is\n$$\\mathbf{F}_k + \\left[\\begin{matrix}0 \u0026 - \\Delta{t} \\omega_{k-1} \u0026 0 \u0026 0\\\\\\Delta{t} \\omega_{k-1} \u0026 0 \u0026 0 \u0026 0\\\\\\Delta{t} \\omega_{k-1} \\omega_{k} \u0026 - \\omega_{k-1} + \\omega_{k} \u0026 0 \u0026 \\Delta{t}\\omega_{k}\\\\\\omega_{k-1} - \\omega_{k} \u0026 \\Delta{t} \\omega_{k-1} \\omega_{k} \u0026 - \\Delta{t} \\omega_{k} \u0026 0\\end{matrix}\\right]$$The Ego-motion Part Since the motion matrix $\\mathbf{F}_k$ follows the constant velocity model:\nIf we assume ego motion is at constant velocity, $$ \\mathbf{F}_k\\mathbf{g}_{k-1}- \\mathbf{g}_k =\\mathbf{0} $$ The results are interesting, which are counter intuitive at first glance. We do not need to account for ego-motion.\nIf we assume ego motion is at constant acceleration, $$ \\mathbf{F}_k\\mathbf{g}_{k-1} - \\mathbf{g_k} = [-\\frac{a}{2}\\Delta{t}^2, -a\\Delta{t}]^\\top $$where $a$ is the acceleration of the ego-car.\nConstant Acceleration Object Position Tracking The Pseudo Motion Matrix With the assumption that $\\dot{\\omega}_k = 0$, $\\dot{\\omega}_{k-1}=0$, and $\\omega_k = \\omega_{k-1}$:\n$$\\begin{aligned} \\hat{\\mathbf{F}}_k \u0026=\\bar{\\mathbf{W}}_k^{-1}\\mathbf{F}_k\\mathbf{W}_{k-1} \\\\ \u0026= \\mathbf{F}_k + \\Delta{\\theta} \\begin{bmatrix} -0.5\\Delta{\\theta} \u0026 -1 \u0026 0 \u0026 -\\Delta{t} \u0026 0 \u0026 0 \\\\ 1 \u0026 -0.5\\Delta{\\theta} \u0026 \\Delta{t}\u0026 0\u00260 \u00260\\\\ 0 \u0026 -0.5\\Delta{\\theta}\\omega \u0026 \\Delta{\\theta} \u0026 -1\u0026 0\u0026 0.5\\Delta{t}\\\\ 0.5\\Delta{\\theta}\\omega \u0026 0 \u0026 1 \u0026 \\Delta{\\theta} \u0026 -0.5\\Delta{t} \u0026 0\\\\ 0.5\\Delta{\\theta}\\omega^2 \u0026 -\\omega^2 \u0026 3\\omega \u0026 \\Delta{\\theta}\\omega \u0026 -0.5\\Delta{\\theta}\u0026 2 \\\\ \\omega^2 \u0026 0.5\\Delta{\\theta}\\omega^2 \u0026 -\\Delta{\\theta}\\omega \u0026 3\\omega \u0026 -2 \u0026 -0.5\\Delta{\\theta} \\end{bmatrix} \\\\ \u0026= \\mathbf{F}_k + \\Delta{\\theta}\\begin{bmatrix} -0.5\\Delta{\\theta}\\mathbf{I} + \\mathbf{C} \u0026 \\Delta{t}\\mathbf{C} \u0026 \\mathbf{0} \\\\ 0.5\\Delta{\\theta}\\mathbf{C} \u0026 \\Delta{\\theta}\\mathbf{I} + \\mathbf{C} \u0026 -0.5\\Delta{t}\\mathbf{C} \\\\ -\\omega^2\\mathbf{C}+0.5\\Delta{\\theta}\\omega^2\\mathbf{I} \u0026 3\\omega\\mathbf{I}-\\Delta{\\theta}\\omega\\mathbf{C} \u0026 -0.5\\Delta{\\theta}\\mathbf{I}-2\\mathbf{C} \\end{bmatrix} \\\\ \u0026= \\mathbf{F}_k + \\Delta{\\theta} \\begin{bmatrix} 0.5\\Delta{\\theta}\\mathbf{C} + \\mathbf{I} \u0026 \\Delta{t}\\mathbf{I} \u0026 \\mathbf{0} \\\\ 0.5\\Delta{\\theta}\\mathbf{I} \u0026 -\\Delta{\\theta}\\mathbf{C} + \\mathbf{I} \u0026 -0.5\\Delta{t}\\mathbf{I} \\\\ -\\omega^2\\mathbf{I}-0.5\\Delta{\\theta}\\omega^2\\mathbf{C} \u0026 -3\\omega\\mathbf{C} - \\Delta{\\theta}\\omega\\mathbf{I} \u0026 0.5\\Delta{\\theta}\\mathbf{C} - 2\\mathbf{I} \\end{bmatrix} \\cdot \\text{diag}(\\mathbf{C}, \\mathbf{C}, \\mathbf{C}) \\end{aligned}$$ Summary In ego-motion compensation, if the motion model of the object and ego-car is different, we need to compensate for ego-motion. Otherwise, we do not need to. We also need the basis rotation angle, $\\theta$, rotation rate, $\\omega$, and rotation acceleration, $\\dot{\\omega}$ to get the full state transition equation.\nPitfalls One may try to estimate the state of the object in the world coordinate, which means\n$$\\begin{aligned} \\mathbf{E}_k \\mathbf{y}_k + \\mathbf{g}_k \u0026= \\mathbf{H}_k \\mathbf{x}_k +\\mathbf{w}_k \\\\ \\mathbf{x}_k \u0026= \\mathbf{F}_k \\mathbf{x}_{k-1} + \\mathbf{n}_k \\end{aligned}$$One first converts the current observed coordinate to the world coordinate by doing $\\mathbf{E}_k\\mathbf{y}_k + \\mathbf{g}_k$, then doing the ordinary Kalman updates. Finally, converts the estimate hidden state by $\\mathbf{E}_k^\\top[ \\hat{\\mathbf{x}}_{k} - \\hat{\\mathbf{g}}_k]$, where $\\hat{\\mathbf{x}}_k$is the updated states in the world coordinate and $\\hat{\\mathbf{g}}_k = [ \\mathbf{g}_k, \\mathbf{0}]^\\top$. However, this method is wrong. Because we can not directly transform the other states (velocity, acceleration, etc.) by simply duplicate operations as in the position transform. As shown in Eq. (1) and Eq. (2), the transformation of velocity and acceleration not only depends on the rotation matrix, it also depends on other attributes of the ego-poses.\n","wordCount":"2144","inLanguage":"en","image":"https://livey.github.io/posts/2024-12-positioning-track/%3Cimage%20path/url%3E","datePublished":"2024-12-02T00:00:00Z","dateModified":"2024-12-02T00:00:00Z","author":{"@type":"Person","name":"Fuwei Li"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://livey.github.io/posts/2024-12-positioning-track/"},"publisher":{"@type":"Organization","name":"Fuwei's Tech Notes","logo":{"@type":"ImageObject","url":"https://livey.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://livey.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://livey.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://livey.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://livey.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://livey.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://livey.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://livey.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Position Filtering with Ego Motion Compensation</h1><div class=post-description>Object's Position Tracking with Ego Motion Compensation</div><div class=post-meta><span title='2024-12-02 00:00:00 +0000 UTC'>December 2, 2024</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;2144 words&nbsp;·&nbsp;Fuwei Li&nbsp;|&nbsp;<a href=https://github.com/livey/livey.github.io/issues/new rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#continuous-form aria-label="Continuous Form">Continuous Form</a><ul><li><a href=#coordinate-definitions aria-label="Coordinate Definitions">Coordinate Definitions</a></li><li><a href=#continuous-motion-in-the-world-coordinate aria-label="Continuous Motion in the World Coordinate">Continuous Motion in the World Coordinate</a></li><li><a href=#continuous-motion-model aria-label="Continuous Motion Model">Continuous Motion Model</a></li></ul></li><li><a href=#discretized-form aria-label="Discretized Form">Discretized Form</a><ul><li><a href=#form-of-state-basis aria-label="Form of State Basis">Form of State Basis</a></li></ul></li><li><a href=#ego-pose-information aria-label="Ego-pose Information">Ego-pose Information</a><ul><ul><li><a href=#ego-motion-compensation aria-label="Ego Motion Compensation">Ego Motion Compensation</a></li></ul></ul></li><li><a href=#object-part-in-the-motion-model aria-label="Object Part in the Motion Model">Object Part in the Motion Model</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li><li><a href=#applications aria-label=Applications>Applications</a><ul><li><a href=#static-object-position-tracking aria-label="Static Object Position Tracking">Static Object Position Tracking</a></li><li><a href=#constant-velocity-object-position-tracking aria-label="Constant Velocity Object Position Tracking">Constant Velocity Object Position Tracking</a><ul><li><a href=#the-pseudo-motion-matrix aria-label="The Pseudo Motion Matrix">The Pseudo Motion Matrix</a></li><li><a href=#the-ego-motion-part aria-label="The Ego-motion Part">The Ego-motion Part</a></li></ul></li><li><a href=#constant-acceleration-object-position-tracking aria-label="Constant Acceleration Object Position Tracking">Constant Acceleration Object Position Tracking</a><ul><li><a href=#the-pseudo-motion-matrix-1 aria-label="The Pseudo Motion Matrix">The Pseudo Motion Matrix</a></li></ul></li></ul></li><li><a href=#summary aria-label=Summary>Summary</a></li><li><a href=#pitfalls aria-label=Pitfalls>Pitfalls</a></li></ul></div></details></div><div class=post-content><p>When tracking an object&rsquo;s position, we always from the ego&rsquo;s perspective. However, ego&rsquo;s motion makes the tracking of the object a little difficult. The basic idea is doing the tracking on the world coordinate, then transforming into the ego-car&rsquo;s coordinate. In this post, we will discuss how to combine the ego&rsquo;s motion into the object&rsquo;s tracking concisely.</p><h1 id=continuous-form>Continuous Form<a hidden class=anchor aria-hidden=true href=#continuous-form>#</a></h1><h2 id=coordinate-definitions>Coordinate Definitions<a hidden class=anchor aria-hidden=true href=#coordinate-definitions>#</a></h2><div style="text-align:center;margin:0 auto;display:flex;justify-content:center"><img src=./resources/diagram.png alt="the relatives of ego and object" style=width:70%></div><p>The target&rsquo;s movement in the world coordinate: $o(t)$; ego-car movement in the world coordinate: $g(t)$; ego-car&rsquo;s heading angle: $\theta(t)$; observed target&rsquo;s coordinate: $f(t)$.</p><h2 id=continuous-motion-in-the-world-coordinate>Continuous Motion in the World Coordinate<a hidden class=anchor aria-hidden=true href=#continuous-motion-in-the-world-coordinate>#</a></h2>$$\mathbf{E}(t)\mathbf{x}(t) = \boldsymbol{o}(t)- \mathbf{g}(t) \tag{1}
$$<p>where</p>$$
\mathbf{E}(t) =
\begin{bmatrix}
\cos \theta(t) & -\sin\theta(t) \\
\sin \theta(t) & \cos\theta(t)
\end{bmatrix}
$$<p>is the basis and it also represents the rotation of the ego car, $\mathbf{x}(t) = [x_x(t), x_y(t)]^\top$ is the observed relative position at time $t$ under the basis $\mathbf{E}(t)$, $\mathbf{o}(t)=[o_x(t), o_y(t)]^\top$ and $\mathbf{g}(t) = [g_x(t), g_y(t)]^\top$ are the object&rsquo;s and ego-car&rsquo;s motion in the world coordinate, respectively. Taking first and second derivatives of the equation (1) with respect to time, we have</p>$$
\partial \mathbf{E} \mathbf{x} + \mathbf{E} \partial \mathbf{x} = \partial (\mathbf{o} -\mathbf{g}) \tag{2}
$$<p>and</p>$$
\partial^2\mathbf{E} \mathbf{x} + 2\partial\mathbf{E}\partial\mathbf{x} + \mathbf{E}\partial^2\mathbf{x} = \partial^2(\mathbf{o} - \mathbf{g}) \tag{3}
$$<p>According to equation (1), the observed relative position satisfies</p>$$
\mathbf{x}(t) = \mathbf{E}^{-1}(t)(\mathbf{o}(t) - \mathbf{g}(t)) \tag{4}
$$<p>Thus, the observed object&rsquo;svelocity satisfies</p>$$
\begin{aligned}
\partial \mathbf{x} = \partial \mathbf{E}^{-1} \,(\mathbf{o} - \mathbf{g}) + \mathbf{E}^{-1}\,(\partial \mathbf{o} - \partial \mathbf{g})
\end{aligned} \tag{5}
$$<p>and the observed object&rsquo;s acceleration satisfies</p>$$
\begin{aligned}
\partial^2 \mathbf{x} 
=& \partial^2 \mathbf{E}^{-1}(\mathbf{o} - \mathbf{g}) + \partial \mathbf{E}^{-1}(\partial \mathbf{o} - \partial\mathbf{g}) \\
&+ \partial \mathbf{E}^{-1}(\partial \mathbf{o} - \partial \mathbf{g}) + \mathbf{E}^{-1}(\partial^2 \mathbf{o} - \partial^2\mathbf{g}) \\ 
=&\partial^2 \mathbf{E}^{-1}(\mathbf{o} - \mathbf{g}) + 2\partial \mathbf{E}^{-1}(\partial \mathbf{o} - \partial\mathbf{g}) 
+  \mathbf{E}^{-1}(\partial^2 \mathbf{o} - \partial^2\mathbf{g}) 
\end{aligned} \tag{6}
$$<p>where</p>$$
\mathbf{E} =
\begin{bmatrix}
\cos\theta  & -\sin\theta \\
\sin\theta & \cos\theta
\end{bmatrix}
$$$$
\mathbf{E}^{-1} =
\begin{bmatrix}
\cos\theta  & \sin\theta \\
-\sin\theta & \cos\theta
\end{bmatrix}
$$$$
\partial\mathbf{E} = 
\partial\theta
\begin{bmatrix}
-\sin\theta & -\cos\theta \\
\cos\theta & -\sin\theta
\end{bmatrix}
$$$$
\partial^2\mathbf{E} = 
\partial^2\theta
\begin{bmatrix}
-\sin\theta & -\cos\theta\\
\cos\theta & -\sin\theta
\end{bmatrix}
+ (\partial\theta)^2
\begin{bmatrix}
-\cos\theta & \sin\theta \\
-\sin\theta & -\cos\theta
\end{bmatrix}
$$$$\partial\mathbf{E}^{-1} = 
\partial\theta \cdot
\begin{bmatrix}
-\sin\theta & \cos\theta\\
-\cos\theta & -\sin\theta
\end{bmatrix}
$$$$
\partial^2\mathbf{E}^{-1} =
\partial^2\theta
\begin{bmatrix}
-\sin\theta & \cos\theta  \\
-\cos\theta & -\sin\theta
\end{bmatrix} +
(\partial \theta)^2
\begin{bmatrix}
-\cos\theta & -\sin\theta\\
\sin\theta & -\cos\theta
\end{bmatrix}.
$$<p>Also,</p>$$
\begin{aligned}
\partial\mathbf{E} \mathbf{x}
& = 
\partial\theta \cdot
\begin{bmatrix}
-\sin\theta & -\cos\theta\\
\cos\theta & -\sin\theta
\end{bmatrix}
\cdot
\mathbf{x} \\
&=
\omega
\mathbf{E}
\begin{bmatrix}
0  & -1 \\
1 & 0
\end{bmatrix}
\cdot
\mathbf{x} \\
&= 
\mathbf{E}
[\omega
]_\times\mathbf{x}
\end{aligned},
$$<p>where $\omega=\partial \theta/\partial t$ is the angular velocity and $[\omega]_\times$ is the skew-symmetric matrix of $\omega$, defined as</p>$$
[\omega]_\times =
\begin{bmatrix}
0 & -\omega \\
\omega & 0
\end{bmatrix}.
$$<p>If we embed the plane into a 3D space, then the rotation $\omega$ can be represented as vector, $[0, 0, \omega]^\top$, and a point, $[x, y]$ in 3D is $[x, y, 0]^\top$. Then the cross product of $\omega$ and $\mathbf{x}$ is</p><h1 id=endbmatrix>$$
\begin{bmatrix}
0\
0\
\omega
\end{bmatrix}
\times
\begin{bmatrix}
x \
y \
0
\end{bmatrix}</h1><p>\omega
\begin{bmatrix}
-y\
x\
0
\end{bmatrix}.
$$</p><p>Its first two elements are indeed $[\omega]_\times\mathbf{x}$. It represents the tangential velocity.
Then the velocity Eq. (2) can be rewritten as</p>$$
\mathbf{E}(\mathbf{v}_r + \mathbf{v}_t) = \mathbf{v}_o - \mathbf{v}_g
$$<p>where $\mathbf{v}_r = \partial \mathbf{x}/ \partial t$ is relative velocity, $\mathbf{v}_t$ is the tangential velocity. If we want to connect the velocity between local and world, we need to subtract the tangential velocity. Further, if the ego-car&rsquo;s velocity is given in its own coordinate system, i.e., $\mathbf{E}\mathbf{v}_e = \mathbf{v}_g$, we have</p>$$
\mathbf{v}_o = \mathbf{E}(\mathbf{v}_r + \mathbf{v}_t + \mathbf{v}_e). \tag{7}
$$<p>This equation gives us clear physical meaning of the velocities.</p><h2 id=continuous-motion-model>Continuous Motion Model<a hidden class=anchor aria-hidden=true href=#continuous-motion-model>#</a></h2><p>The motion ordinary differential equation (ODE) is</p>$$\dot{\mathbf{o}}(t) = \mathbf{A}\mathbf{o}(t) + \mathbf{n}(t)$$<p>where if it is a constant velocity model, we have $\mathbf{o}(t) = [s(t), \dot{s}(t)]^\top $,</p>$$
\mathbf{A} =
\begin{bmatrix}
0 & 1\\
0 & 0
\end{bmatrix}
$$<p>$\mathbf{n}(t) = [0, n]^\top$, and if it is a constant acceleration model we have $\mathbf{o}(t) = [s(t), \dot{s}(t), \ddot{s}(t)]^\top$,</p>$$
\mathbf{A} =
\begin{bmatrix}
0 & 1 & 0\\
0 & 0 & 1\\
0 & 0 & 0
\end{bmatrix}
$$<p>$\mathbf{n}(t) = [0, 0, n]^\top$.</p><h1 id=discretized-form>Discretized Form<a hidden class=anchor aria-hidden=true href=#discretized-form>#</a></h1><p>Please refere to the <a href=/posts/2024-12-pose-tracking/>Appendix</a> of the pose tracking post for how to discretize the continuous motion model.</p><p>We would like to derive a recursive formula for the relative states, $\mathbf{x}$, where $\mathbf{x}$ can contain the relative position, velocity, and acceleration. For the objective and ego, $\mathbf{o}$ and $\mathbf{g}$ can also contain the position, velocity, and acceleration. The state transition and observation functions are</p>$$
\begin{aligned}
\mathbf{B}_{k-1}\mathbf{x}_{k-1} &= \mathbf{o}_{k-1} - \mathbf{g}_{k-1} & (8.1)\\
\mathbf{B}_{k} \mathbf{x}_{k} &= \mathbf{o}_{k} - \mathbf{g}_{k} & (8.2)\\
\mathbf{o}_{k} &= \mathbf{F}_{k}\circ\mathbf{o}_{k-1} + \mathbf{n}_k & (8.3)\\
\mathbf{y}_{k} &= \mathbf{H}_{k}\mathbf{x}_{k} + \mathbf{w}_{k} & (8.4)
\end{aligned}
$$<p>where $\mathbf{y}_{k}$ and $\mathbf{w}_{k}$ are the observation and observation noise, respectively. &ldquo;$\circ$&rdquo; denotes the function composition. $\mathbf{B}$ is the rotation basis matrix as will discuss in following section.</p><p>Substitue equation (6.1) and (6.2) into equation (6.3), we have a recurvise relationship between relative states in the ego-car&rsquo;s coordinates at time $k-1$ and $k$:</p>$$
\mathbf{B}_{k}\mathbf{x}_{k} + \mathbf{g}_{k}= \mathbf{F}_k\circ [\mathbf{B}_{k-1}\mathbf{x}_{k-1}+ \mathbf{g}_{k-1}]+ \mathbf{n}_k
$$<p>Then the predicted states in the ego-car&rsquo;s coordinate at time $k$:</p>$$
\mathbf{x}_k = \mathbf{B}_k^{-1}[\mathbf{F}_k\circ(\mathbf{B}_{k-1}\mathbf{x}_{k-1}+\mathbf{g}_{k-1}) - \mathbf{g}_{k} + \mathbf{n}_k] \tag{9}
$$<h2 id=form-of-state-basis>Form of State Basis<a hidden class=anchor aria-hidden=true href=#form-of-state-basis>#</a></h2><p>In the following, we will derive the general form for the basis of states, $\mathbf{B}$.</p><p>According to Eq. (1), (2) and (3), for a constant velocity model we have</p>$$
\mathbf{B} = 
\begin{bmatrix}
\mathbf{E} & \mathbf{0} \\
\partial \mathbf{E} & \mathbf{E}
\end{bmatrix}
$$<p>and for the constant acceleration model we have</p>$$
\mathbf{B} = 
\begin{bmatrix}
\mathbf{E} & \mathbf{0} & \mathbf{0} \\
\partial \mathbf{E} & \mathbf{E} & \mathbf{0} \\
\partial^2 \mathbf{E} & 2\partial\mathbf{E} & \mathbf{E}
\end{bmatrix}
$$<p>According to Eq. (4), (5), and (6), for constant velocity model</p>$$
\mathbf{B}^{-1} = 
\begin{bmatrix}
\mathbf{E}^{-1} & \mathbf{0} \\
\partial\mathbf{E}^{-1} & \mathbf{E}^{-1}
\end{bmatrix}
$$<p>and for a constant acceleration model we have</p>$$
\mathbf{B}^{-1} = 
\begin{bmatrix}
\mathbf{E}^{-1} & \mathbf{0} & \mathbf{0} \\
\partial\mathbf{E}^{-1} & \mathbf{E}^{-1} & \mathbf{0} \\
\partial^2\mathbf{E}^{-1} & 2\partial\mathbf{E}^{-1} & \mathbf{E}^{-1}
\end{bmatrix}
$$<p>Since $\partial(\mathbf{E}^{-1}\mathbf{E}) = \partial\mathbf{E}^{-1}\mathbf{E} + \mathbf{E}^{-1}\partial\mathbf{E} = \mathbf{0}$, we have</p>$$
\begin{aligned}
\partial\mathbf{E} 
&=-\mathbf{E}\partial\mathbf{E}^{-1}\mathbf{E}  \\
&=-\partial\theta
\begin{bmatrix}
0 & 1 \\
-1 & 0
\end{bmatrix}
\mathbf{E}\\
&\triangleq
\omega
\mathbf{C}\mathbf{E} =\omega\mathbf{E}\mathbf{C}
\end{aligned}
$$<p>where</p>$$\mathbf{C} =
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
$$<p>$\omega = \frac{\partial\theta}{\partial{t}}$, $\mathbf{C}^\top=-\mathbf{C}$, $\mathbf{C}\mathbf{C}^\top=\mathbf{I}$.</p>$$
\begin{aligned}
\partial\mathbf{E}^{-1}
&=-\mathbf{E}^{-1}\partial\mathbf{E} \mathbf{E}^{-1} \\
&=-\partial\theta
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
\mathbf{E}^{-1}\\
&\triangleq 
\omega \mathbf{C}^{-1}\mathbf{E}^{-1} \\
&= \omega\mathbf{E}^{-1}\mathbf{C}^{-1}
\end{aligned}
$$<p>and</p>$$
\begin{aligned}
\partial^2\mathbf{E} 
&= -\mathbf{E}(2\partial\mathbf{E}^{-1}\partial\mathbf{E}+ \partial^2\mathbf{E}^{-1}\mathbf{E}) \\
&= -\mathbf{E}(2\omega^2\mathbf{I} - \omega^2\mathbf{I}-\dot{\omega}\mathbf{C}) \\
&\triangleq 
[\dot{\omega}\mathbf{C}-\omega^2\mathbf{I}]\mathbf{E} \\
&=
\mathbf{E}[\dot{\omega}\mathbf{C}-\omega^2\mathbf{I}]
\end{aligned}
$$$$
\begin{aligned}
\partial^2\mathbf{E}^{-1} 
&= -(2\partial\mathbf{E}^{-1}\partial\mathbf{E} + \mathbf{E}^{-1}\partial^2\mathbf{E})\mathbf{E}^{-1} \\
&=-(2\omega^2\mathbf{I} -\omega^2\mathbf{I} - \partial^2\theta\mathbf{C})\mathbf{E}^{-1} \\
&\triangleq [\dot{\omega}\mathbf{C}^{-1} - \omega^2\mathbf{I}]
\mathbf{E}^{-1} \\
&=
\mathbf{E}^{-1} [\dot{\omega}\mathbf{C}^{-1} - \omega^2\mathbf{I}]
\end{aligned}
$$<p>Combine these and we can simplify</p>$$
\mathbf{B} = 
\text{diag}(\mathbf{E}, \mathbf{E})
\cdot
\begin{bmatrix}
\mathbf{I} & \mathbf{0} \\
\omega\mathbf{C} & \mathbf{I}
\end{bmatrix}  = \text{diag}(\mathbf{E}, \mathbf{E})\mathbf{W}
$$$$
\mathbf{B}^{-1} =
\begin{bmatrix}
\mathbf{I} & \mathbf{0}\\
\omega\mathbf{C}^{-1} & \mathbf{I} 
\end{bmatrix}
\cdot
\text{diag}(\mathbf{E}^{-1}, \mathbf{E}^{-1}) =\mathbf{W}^{-1}\cdot\text{diag}(\mathbf{E}^{-1}, \mathbf{E}^{-1}).
$$<p>For state that contains position, velocity, and acceleration, we have</p>$$
\begin{aligned}
\mathbf{B} 
&= 
\text{diag}(\mathbf{E}, \mathbf{E}, \mathbf{E})
\cdot
\begin{bmatrix}
\mathbf{I} & \mathbf{0} & \mathbf{0}\\
\omega\mathbf{C} & \mathbf{I} & \mathbf{0} \\
\dot{\omega}\mathbf{C}-\omega^2\mathbf{I} & 2\omega\mathbf{C} & \mathbf{I}
\end{bmatrix} \\
&=
\text{diag}(\mathbf{E}, \mathbf{E}, \mathbf{E})\mathbf{W}
\end{aligned}
$$<p>and</p>$$
\begin{aligned}
\mathbf{B}^{-1}
&=
\begin{bmatrix}
\mathbf{I} & \mathbf{0} & \mathbf{0}\\
\omega\mathbf{C}^{-1} & \mathbf{I} &\mathbf{0}\\
\dot{\omega}\mathbf{C}^{-1}-\omega^2\mathbf{I} & 2\omega\mathbf{C}^{-1} & \mathbf{I} 
\end{bmatrix}
\cdot
\text{diag}(\mathbf{E}^{-1}, \mathbf{E}^{-1},\mathbf{E}^{-1}) \\
&= \mathbf{W}^{-1}\text{diag}(\mathbf{E}^{-1}, \mathbf{E}^{-1},\mathbf{E}^{-1})
\end{aligned}
$$<h1 id=ego-pose-information>Ego-pose Information<a hidden class=anchor aria-hidden=true href=#ego-pose-information>#</a></h1><p>In a regular system, the information of the ego-car includes: the translation, $\mathbf{t}_k$, from $k-1$ to $k$ and the coordinate rotation matrix $\mathbf{R}_k$, or ego velocity, $\mathbf{v}_k$, the angular velocity, $\omega_k$. Represent the ego-car&rsquo;s information in the world coordinate we have</p>$$
\mathbf{E}_k\mathbf{t}_k = \mathbf{g}_{k-1} - \mathbf{g}_{k}
,\quad
\mathbf{E}_k\mathbf{v}_k
,\quad
\mathbf{R}_k = \mathbf{E}_k^{-1}\mathbf{E}_{k-1}
$$<h3 id=ego-motion-compensation>Ego Motion Compensation<a hidden class=anchor aria-hidden=true href=#ego-motion-compensation>#</a></h3><p>According to Eq. (9) we have;</p>$$\begin{aligned}
\mathbf{x}_{k} 
&= \mathbf{B}_{k}^{-1} [\mathbf{F}_k\circ(\mathbf{B}_{k-1}\mathbf{x}_{k-1} +\mathbf{g}_{k-1}) - \mathbf{g}_{k} + \mathbf{n}_k] \\
&= 
\mathbf{B}^{-1}_{k}
\left( \mathbf{F}_k\circ(\mathbf{B}_{k-1}\mathbf{x}_{k-1}) + \mathbf{F}_{k}\circ\mathbf{g}_{k-1} - \mathbf{g}_{k}+ \mathbf{n}_k \right) 
\end{aligned}$$<p>And assume the ego motion has the same motion pattern as for the object, then we have</p>$$
\begin{aligned}
\mathbf{F}_k\circ\mathbf{g}_{k-1} - \mathbf{g}_k  = \mathbf{n}_{g_k} 
\end{aligned}
$$<p>where $\mathbf{n}_{g_k}$ is the process noise for the ego-car at time $k$.</p><h1 id=object-part-in-the-motion-model>Object Part in the Motion Model<a hidden class=anchor aria-hidden=true href=#object-part-in-the-motion-model>#</a></h1><p>The part that involves the object in the motion model is $\mathbf{B}_k^{-1}\mathbf{F}_k\circ\mathbf{B}_{k-1}\mathbf{x}_{k-1}$. Substitute the expression of $\mathbf{B}_k^{-1}$ we have</p>$$
\begin{aligned}
\mathbf{B}_k^{-1}\mathbf{F}_k\circ(\mathbf{B}_{k-1}\mathbf{x}_{k-1}) 
&\overset{(a)}{=} \mathbf{W}_k^{-1}\cdot\text{diag}(\mathbf{E}_{k}^{-1}, \mathbf{E}_{k}^{-1}, \cdots) \cdot \mathbf{F}_k \cdot\text{diag}(\mathbf{E}_{k-1}, \mathbf{E}_{k-1}, \cdots)\mathbf{W}_{k-1}\mathbf{x}_{k-1} \\
&\overset{(b)}{=} \mathbf{W}_k^{-1}\text{diag}(\mathbf{R}_k, \mathbf{R}_k, \cdots)\mathbf{F}_k\mathbf{W}_{k-1}\mathbf{x}_{k-1} \\
&\overset{(c)}{=} 
\mathbf{W}_k^{-1}\mathbf{F}_k\text{diag}(\mathbf{R}_k, \mathbf{R}_k, \cdots)\mathbf{W}_{k-1}\mathbf{x}_{k-1}\\
&\overset{(d)}{=}
\bar{\mathbf{R}}_k\mathbf{W}_k^{-1}\mathbf{F}_k\mathbf{W}_{k-1}\mathbf{x}_{k-1}\\
&\triangleq\bar{\mathbf{R}}_k\hat{\mathbf{F}}_k\mathbf{x}_{k-1}
\end{aligned}
$$<p>where $\mathbf{R}_k = \mathbf{E}_k^{-1}\mathbf{E}_{k-1} = \mathbf{E}(\theta_{k-1} - \theta_k)$, $\bar{\mathbf{R}}_k = \text{diag}(\mathbf{R}_k, \cdots)$, (a) established by substitute $\mathbf{F}_k\circ$ by its matrix formular, $\mathbf{F}_k\cdot$, (b) and (c) substatiates due to the assumption that $\bar{\mathbf{R}}\mathbf{F} = \mathbf{F}\bar{\mathbf{R}}$, which is true for a constant velocity or constant acceleration model, (d) is true as a result of $\bar{\mathbf{R}}\mathbf{W}^{-1}=\mathbf{W}^{-1} \bar{\mathbf{R}}$. It indicates that the order of following motion model and rotate coordinate does not matter. We can formulate the motion model only depending on the relative rotation because we can exchange the motion and the coordinate.</p><h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1><p>The complete Kalman filter with ego-motion compensation is as follows:</p><ol><li><p>Do prediction with pseudo motion matrix,</p><ol><li><p>Subtract the ego rotation</p></li><li><p>Follow motion model</p></li><li><p>Add ego rotation</p></li><li><p>Rotate</p></li></ol></li><li><p>Compensate the ego-motion</p></li><li><p>Do correction as in traditional Kalman filter.</p></li></ol><h1 id=applications>Applications<a hidden class=anchor aria-hidden=true href=#applications>#</a></h1><h2 id=static-object-position-tracking>Static Object Position Tracking<a hidden class=anchor aria-hidden=true href=#static-object-position-tracking>#</a></h2><p>For a static object, its position does not change. So, the motion matrix is</p><p>$\mathbf{F} = \mathbf{I}$, $\mathbf{B} = \mathbf{E}$, and $\mathbf{W}=\mathbf{I}$.</p><p>We have $\hat{\mathbf{F}}_k = \mathbf{R}_k$. So that</p>$$
\mathbf{x}_k =\mathbf{R}_k \mathbf{x}_{k-1} + \mathbf{E}_k^{-1}\mathbf{n}_{g_k} + \mathbf{n}_k
$$<p>where $\mathbf{n}_{g_k} = \mathbf{g}_{k-1} - \mathbf{g}_k=\mathbf{E}_k\mathbf{t}_k$. Thus, we get</p>$$
\mathbf{x}_k =\mathbf{R}_k\mathbf{x}_{k-1} + \mathbf{t}_k + \mathbf{n}_k
$$<p>It means, in this case, we need to compensate for the relative translation and rotation.</p><h2 id=constant-velocity-object-position-tracking>Constant Velocity Object Position Tracking<a hidden class=anchor aria-hidden=true href=#constant-velocity-object-position-tracking>#</a></h2><h3 id=the-pseudo-motion-matrix>The Pseudo Motion Matrix<a hidden class=anchor aria-hidden=true href=#the-pseudo-motion-matrix>#</a></h3>$$
\begin{aligned}
\hat{\mathbf{F}}_k 
&=\bar{\mathbf{W}}_k^{-1}\mathbf{F}_k\mathbf{W}_{k-1} \\
&= \mathbf{F}_k + 
\begin{bmatrix}
\Delta{t}\omega_{k-1}\mathbf{C} & \mathbf{0} \\
\Delta{t}\omega_k\omega_{k-1}\mathbf{I} + (\omega_{k-1}-\omega_k)\mathbf{C} & -\Delta{t}\omega_k\mathbf{C}
\end{bmatrix} \\
&\overset{(a)}{=}\mathbf{F}_k + 
\Delta{\theta}
\begin{bmatrix}
\mathbf{I} & \mathbf{0} \\
-\omega_k\mathbf{C} & -\mathbf{I}
\end{bmatrix}
\begin{bmatrix}
\mathbf{C} & \mathbf{0} \\
\mathbf{0} & \mathbf{C}
\end{bmatrix}
\end{aligned}
$$<p>where (a) is true with assumption $\omega_k = \omega_{k-1}$. The second term which involves the rotated angle is usually ignored by others.</p><p>The complete form of $\hat{\mathbf{F}}_k$ is</p>$$\mathbf{F}_k + \left[\begin{matrix}0 & - \Delta{t} \omega_{k-1} & 0 & 0\\\Delta{t} \omega_{k-1} & 0 & 0 & 0\\\Delta{t} \omega_{k-1} \omega_{k} & - \omega_{k-1} + \omega_{k} & 0 & \Delta{t}\omega_{k}\\\omega_{k-1} - \omega_{k} & \Delta{t} \omega_{k-1} \omega_{k} & - \Delta{t} \omega_{k} & 0\end{matrix}\right]$$<h3 id=the-ego-motion-part>The Ego-motion Part<a hidden class=anchor aria-hidden=true href=#the-ego-motion-part>#</a></h3><p>Since the motion matrix $\mathbf{F}_k$ follows the constant velocity model:</p><ol><li>If we assume ego motion is at constant velocity,
$$
\mathbf{F}_k\mathbf{g}_{k-1}- \mathbf{g}_k =\mathbf{0}
$$</li></ol><p>The results are interesting, which are counter intuitive at first glance. We do not need to account for ego-motion.</p><ol><li>If we assume ego motion is at constant acceleration,</li></ol>$$
\mathbf{F}_k\mathbf{g}_{k-1} - \mathbf{g_k} = [-\frac{a}{2}\Delta{t}^2, -a\Delta{t}]^\top
$$<p>where $a$ is the acceleration of the ego-car.</p><h2 id=constant-acceleration-object-position-tracking>Constant Acceleration Object Position Tracking<a hidden class=anchor aria-hidden=true href=#constant-acceleration-object-position-tracking>#</a></h2><h3 id=the-pseudo-motion-matrix-1>The Pseudo Motion Matrix<a hidden class=anchor aria-hidden=true href=#the-pseudo-motion-matrix-1>#</a></h3><p>With the assumption that $\dot{\omega}_k = 0$, $\dot{\omega}_{k-1}=0$, and $\omega_k = \omega_{k-1}$:</p>$$\begin{aligned}
\hat{\mathbf{F}}_k 
&=\bar{\mathbf{W}}_k^{-1}\mathbf{F}_k\mathbf{W}_{k-1} \\
&= \mathbf{F}_k + 
\Delta{\theta}
\begin{bmatrix}
-0.5\Delta{\theta} & -1 & 0 & -\Delta{t} & 0 & 0 \\
1 & -0.5\Delta{\theta} & \Delta{t}& 0&0 &0\\
0 & -0.5\Delta{\theta}\omega & \Delta{\theta} & -1& 0& 0.5\Delta{t}\\
0.5\Delta{\theta}\omega & 0 & 1 & \Delta{\theta} & -0.5\Delta{t} & 0\\
0.5\Delta{\theta}\omega^2 & -\omega^2 & 3\omega & \Delta{\theta}\omega & -0.5\Delta{\theta}& 2 \\
\omega^2 & 0.5\Delta{\theta}\omega^2 & -\Delta{\theta}\omega & 3\omega & -2 & -0.5\Delta{\theta}
\end{bmatrix} \\
&=
\mathbf{F}_k + 
\Delta{\theta}\begin{bmatrix}
-0.5\Delta{\theta}\mathbf{I} + \mathbf{C} & \Delta{t}\mathbf{C} & \mathbf{0} \\
0.5\Delta{\theta}\mathbf{C} & \Delta{\theta}\mathbf{I} + \mathbf{C} & -0.5\Delta{t}\mathbf{C} \\
-\omega^2\mathbf{C}+0.5\Delta{\theta}\omega^2\mathbf{I} & 3\omega\mathbf{I}-\Delta{\theta}\omega\mathbf{C} & -0.5\Delta{\theta}\mathbf{I}-2\mathbf{C}
\end{bmatrix} \\
&=
\mathbf{F}_k + 
\Delta{\theta}
\begin{bmatrix}
0.5\Delta{\theta}\mathbf{C} + \mathbf{I} & \Delta{t}\mathbf{I} & \mathbf{0} \\
0.5\Delta{\theta}\mathbf{I} & -\Delta{\theta}\mathbf{C} + \mathbf{I} & -0.5\Delta{t}\mathbf{I} \\
-\omega^2\mathbf{I}-0.5\Delta{\theta}\omega^2\mathbf{C} & -3\omega\mathbf{C} - \Delta{\theta}\omega\mathbf{I} & 0.5\Delta{\theta}\mathbf{C} - 2\mathbf{I} 
\end{bmatrix}
\cdot \text{diag}(\mathbf{C}, \mathbf{C}, \mathbf{C})
\end{aligned}$$<h1 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h1><p>In ego-motion compensation, if the motion model of the object and ego-car is different, we need to compensate for ego-motion. Otherwise, we do not need to. We also need the basis rotation angle, $\theta$, rotation rate, $\omega$, and rotation acceleration, $\dot{\omega}$ to get the full state transition equation.</p><h1 id=pitfalls>Pitfalls<a hidden class=anchor aria-hidden=true href=#pitfalls>#</a></h1><p>One may try to estimate the state of the object in the world coordinate, which means</p>$$\begin{aligned}
\mathbf{E}_k \mathbf{y}_k + \mathbf{g}_k &= \mathbf{H}_k \mathbf{x}_k +\mathbf{w}_k \\
\mathbf{x}_k &= \mathbf{F}_k \mathbf{x}_{k-1} + \mathbf{n}_k
\end{aligned}$$<p>One first converts the current observed coordinate to the world coordinate by doing $\mathbf{E}_k\mathbf{y}_k + \mathbf{g}_k$, then doing the ordinary Kalman updates. Finally, converts the estimate hidden state by $\mathbf{E}_k^\top[ \hat{\mathbf{x}}_{k} - \hat{\mathbf{g}}_k]$, where $\hat{\mathbf{x}}_k$is the updated states in the world coordinate and $\hat{\mathbf{g}}_k = [ \mathbf{g}_k, \mathbf{0}]^\top$. However, this method is wrong. Because we can not directly transform the other states (velocity, acceleration, etc.) by simply duplicate operations as in the position transform. As shown in Eq. (1) and Eq. (2), the transformation of velocity and acceleration not only depends on the rotation matrix, it also depends on other attributes of the ego-poses.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://livey.github.io/tags/autonomous-driving/>Autonomous Driving</a></li><li><a href=https://livey.github.io/tags/signal-processing/>Signal Processing</a></li><li><a href=https://livey.github.io/tags/kalman-filter/>Kalman Filter</a></li><li><a href=https://livey.github.io/tags/position-tracking/>Position Tracking</a></li></ul><nav class=paginav><a class=prev href=https://livey.github.io/posts/2024-12-pose-tracking/><span class=title>« Prev</span><br><span>Pose Tracking with Iterative Extended Kalman Filter</span>
</a><a class=next href=https://livey.github.io/posts/2024-12-angle-filter/><span class=title>Next »</span><br><span>Angle Kalman Filter</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Position Filtering with Ego Motion Compensation on x" href="https://x.com/intent/tweet/?text=Position%20Filtering%20with%20Ego%20Motion%20Compensation&amp;url=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-positioning-track%2f&amp;hashtags=AutonomousDriving%2cSignalProcessing%2cKalmanFilter%2cPositionTracking"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Position Filtering with Ego Motion Compensation on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-positioning-track%2f&amp;title=Position%20Filtering%20with%20Ego%20Motion%20Compensation&amp;summary=Position%20Filtering%20with%20Ego%20Motion%20Compensation&amp;source=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-positioning-track%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Position Filtering with Ego Motion Compensation on reddit" href="https://reddit.com/submit?url=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-positioning-track%2f&title=Position%20Filtering%20with%20Ego%20Motion%20Compensation"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Position Filtering with Ego Motion Compensation on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-positioning-track%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Position Filtering with Ego Motion Compensation on whatsapp" href="https://api.whatsapp.com/send?text=Position%20Filtering%20with%20Ego%20Motion%20Compensation%20-%20https%3a%2f%2flivey.github.io%2fposts%2f2024-12-positioning-track%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Position Filtering with Ego Motion Compensation on telegram" href="https://telegram.me/share/url?text=Position%20Filtering%20with%20Ego%20Motion%20Compensation&amp;url=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-positioning-track%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Position Filtering with Ego Motion Compensation on ycombinator" href="https://news.ycombinator.com/submitlink?t=Position%20Filtering%20with%20Ego%20Motion%20Compensation&u=https%3a%2f%2flivey.github.io%2fposts%2f2024-12-positioning-track%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://livey.github.io/>Fuwei's Tech Notes</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>